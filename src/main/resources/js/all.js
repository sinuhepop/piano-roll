document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        var output = new PianoKeyboard(1232, 150, Notes.fromString('A1'), Notes.fromString('C9'));
        if (MidiUtils.inputs.length > 0) {
            var input = MidiUtils.createInput('defaultMidi', 0);
        }
        window['output'] = output;
        window['piano'] = MidiUtils.createOutput('piano', 0);
    });
});
class Input {
    constructor(id) {
        this.id = id;
    }
    start(p, velocity) {
        if (this.onStart != null) {
            this.onStart(p, velocity);
        }
    }
    stop(p) {
        if (this.onStop != null) {
            this.onStop(p);
        }
    }
}
class Notes {
    static latinName(p) {
        return Notes.latinNames[p];
    }
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.pitchClass;
    }
    static forNumber(n) {
        return { octave: n / 12 + 4, pitchClass: n % 12 };
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
    static toString(p) {
        return PitchClass[p.pitchClass].replace('s', '#') + p.octave;
    }
    static fromString(s) {
        var p = new Pitch();
        p.octave = parseInt(s.substring(s.length - 1));
        p.pitchClass = PitchClass[s.substring(0, s.length - 1).replace('#', 's')];
        return p;
    }
}
Notes.defaultVelocity = 0.7;
Notes.latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
class Output {
    constructor(id) {
        this.id = id;
    }
}
class Connector {
    addInput(i) {
        this.inputs.push(i);
        i.onStart = (p, velocity) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.start(p, velocity);
                }
            });
        };
        i.onStop = (p) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.stop(p);
                }
            });
        };
    }
    addOutput(o) {
        this.outputs.push(o);
    }
}
class Keyboard extends Input {
    constructor() {
        super('keyboard');
        this.keys = 'zsxdcvgbhnjmq2w3er5t6y7ui9o0p';
        window.onkeydown = evt => this.start(this.forKey(evt.which), Notes.defaultVelocity);
        window.onkeyup = evt => this.stop(this.forKey(evt.which));
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="../ext/webmidi.d.ts" />
class MidiMessage {
}
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n) {
        return new MidiInput(id, this.inputs[n]);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return { octave: Math.trunc(code / 12), pitchClass: code % 12 };
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.pitchClass;
    }
}
MidiUtils.enabled = false;
class MidiInput extends Input {
    constructor(id, input) {
        super(id);
        this.input = input;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            console.log(evt.data, m, pitch, Notes.toString(pitch));
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                this.stop(pitch);
            }
            else if (m.type == 144) {
                this.start(pitch, m.velocity / 127);
            }
        };
    }
}
class MidiOutput extends Output {
    constructor(id, output) {
        super(id);
        this.output = output;
    }
    start(p, velocity) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: Math.trunc(velocity * 127) // 
        }));
    }
    stop(p) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: 0
        }));
    }
}
class Oscillator extends Output {
    constructor(type) {
        super('oscillator');
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch, velocity) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
}
class OutputChorus extends Output {
    constructor(id, output, delay, decay, times) {
        super(id);
        this.output = output;
        this.delay = delay;
        this.decay = decay;
        this.times = times;
    }
    start(pitch, velocity) {
        for (var i = 0; i < this.times; i++) {
            velocity *= this.decay;
            setTimeout(() => this.output.start(pitch, velocity, this.delay * (i + 1)));
        }
    }
    stop(pitch) {
        setTimeout(() => this.output.stop(pitch), this.delay * (this.times + 1));
    }
}
class PianoKeyboard extends Output {
    constructor(width, height, first, last) {
        super('pianoKeyboard');
        this.first = Notes.asNumber(first);
        this.keys = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(width / this.keys);
        this.canvas = document.createElement('canvas');
        this.canvas.width = width;
        this.canvas.height = height;
        this.canvas.style.border = '3px solid';
        this.ctx = this.canvas.getContext('2d');
        this.drawKeys();
        document.body.appendChild(this.canvas);
        this.canvas.onclick = evt => console.log(evt);
    }
    start(pitch) {
        this.drawPressed(pitch, 'red');
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = 'black';
        for (var key = 0; key < this.keys; key++) {
            var start = key * this.whiteKeyWidth;
            this.ctx.rect(start, 0, this.whiteKeyWidth, this.canvas.height);
            console.log(key, this.whiteKeyWidth, this.keys * this.whiteKeyWidth);
        }
        this.ctx.stroke();
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.first;
        let center = (n + 0.5) * this.whiteKeyWidth;
        this.ctx.beginPath();
        this.ctx.lineWidth = 0;
        this.ctx.arc(center, this.canvas.height * 0.8, this.whiteKeyWidth * 0.3, 0, 2 * Math.PI, false);
        this.ctx.fillStyle = color;
        this.ctx.fill();
    }
}
var PitchClass;
(function (PitchClass) {
    PitchClass[PitchClass["C"] = 0] = "C";
    PitchClass[PitchClass["Cs"] = 1] = "Cs";
    PitchClass[PitchClass["D"] = 2] = "D";
    PitchClass[PitchClass["Ds"] = 3] = "Ds";
    PitchClass[PitchClass["E"] = 4] = "E";
    PitchClass[PitchClass["F"] = 5] = "F";
    PitchClass[PitchClass["Fs"] = 6] = "Fs";
    PitchClass[PitchClass["G"] = 7] = "G";
    PitchClass[PitchClass["Gs"] = 8] = "Gs";
    PitchClass[PitchClass["A"] = 9] = "A";
    PitchClass[PitchClass["As"] = 10] = "As";
    PitchClass[PitchClass["B"] = 11] = "B";
})(PitchClass || (PitchClass = {}));
var Accidental;
(function (Accidental) {
    Accidental[Accidental["Natural"] = 0] = "Natural";
    Accidental[Accidental["Sharp"] = 1] = "Sharp";
    Accidental[Accidental["Flat"] = 2] = "Flat";
})(Accidental || (Accidental = {}));
var DurationType;
(function (DurationType) {
    DurationType[DurationType["Real"] = 0] = "Real";
    DurationType[DurationType["Sheet"] = 1] = "Sheet";
})(DurationType || (DurationType = {}));
class Pitch {
}
class Note {
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvSW5wdXQudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvTm90ZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvT3V0cHV0LnRzIiwiLi4vdHlwZXNjcmlwdC9pbXBsL0Nvbm5lY3Rvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvT3NjaWxsYXRvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9PdXRwdXRDaG9ydXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvY29yZS90eXBlcy50cyIsIi4uL3R5cGVzY3JpcHQvY29yZS9tZXNzYWdlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7SUFDMUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQztRQUN4QixJQUFJLE1BQU0sR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzFGLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsSUFBSSxLQUFLLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUNELE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUM7UUFDMUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLFNB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Q0FBQTtJQUFFLGlEQUFLLENBQUE7QUFDZixDQUFDLEVBRkksWUFBWSxLQUFaLFlBQVksUUFFaEI7QUFFRDtDQUdDO0FBRUQ7Q0FJQyIsInNvdXJjZXNDb250ZW50IjpbImRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHtcbiAgICBNaWRpVXRpbHMuaW5pdGlhbGl6ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICB2YXIgb3V0cHV0ID0gbmV3IFBpYW5vS2V5Ym9hcmQoMTIzMiwgMTUwLCBOb3Rlcy5mcm9tU3RyaW5nKCdBMScpLCBOb3Rlcy5mcm9tU3RyaW5nKCdDOScpKTtcbiAgICAgICAgaWYgKE1pZGlVdGlscy5pbnB1dHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIGlucHV0ID0gTWlkaVV0aWxzLmNyZWF0ZUlucHV0KCdkZWZhdWx0TWlkaScsIDApO1xuICAgICAgICB9XG4gICAgICAgIHdpbmRvd1snb3V0cHV0J10gPSBvdXRwdXQ7XG4gICAgICAgIHdpbmRvd1sncGlhbm8nXSA9IE1pZGlVdGlscy5jcmVhdGVPdXRwdXQoJ3BpYW5vJywgMCk7XG4gICAgfSk7XG59KTsiLCJhYnN0cmFjdCBjbGFzcyBJbnB1dCB7XG5cbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuICAgIG9uU3RhcnQ6ICgocDogUGl0Y2gsIHZlbG9jaXR5OiBudW1iZXIpID0+IGFueSkgfCBudWxsO1xuICAgIG9uU3RvcDogKChwOiBQaXRjaCkgPT4gYW55KSB8IG51bGw7XG5cbiAgICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc3RhcnQocDogUGl0Y2gsIHZlbG9jaXR5OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHRoaXMub25TdGFydCAhPSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLm9uU3RhcnQocCwgdmVsb2NpdHkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHN0b3AocDogUGl0Y2gpIHtcbiAgICAgICAgaWYgKHRoaXMub25TdG9wICE9IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMub25TdG9wKHApO1xuICAgICAgICB9XG4gICAgfVxuXG59IiwiYWJzdHJhY3QgY2xhc3MgTm90ZXMge1xuXG4gICAgc3RhdGljIHJlYWRvbmx5IGRlZmF1bHRWZWxvY2l0eSA9IDAuNztcblxuICAgIHByaXZhdGUgc3RhdGljIGxhdGluTmFtZXMgPSBbJ0RvJywgJ0RvIycsICdSZScsICdSZSMnLCAnTWknLCAnRmEnLCAnRmEjJywgJ1NvbCcsICdTb2wjJywgJ0xhJywgJ0xhIycsICdTaSddO1xuXG5cbiAgICBzdGF0aWMgbGF0aW5OYW1lKHA6IFBpdGNoQ2xhc3MpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gTm90ZXMubGF0aW5OYW1lc1twXTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXNOdW1iZXIocDogUGl0Y2gpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gKHAub2N0YXZlIC0gNCkgKiAxMiArIHAucGl0Y2hDbGFzcztcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9yTnVtYmVyKG46IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIHsgb2N0YXZlOiBuIC8gMTIgKyA0LCBwaXRjaENsYXNzOiBuICUgMTIgfVxuICAgIH1cblxuICAgIHN0YXRpYyBmcmVxdWVuY3kocDogUGl0Y2gpIHtcbiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIChOb3Rlcy5hc051bWJlcihwKSAtIDQ5KSAvIDEyKSAqIDQ0MDtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9TdHJpbmcocDogUGl0Y2gpIHtcbiAgICAgICAgcmV0dXJuIFBpdGNoQ2xhc3NbcC5waXRjaENsYXNzXS5yZXBsYWNlKCdzJywgJyMnKSArIHAub2N0YXZlO1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tU3RyaW5nKHM6IHN0cmluZykge1xuICAgICAgICB2YXIgcCA9IG5ldyBQaXRjaCgpO1xuICAgICAgICBwLm9jdGF2ZSA9IHBhcnNlSW50KHMuc3Vic3RyaW5nKHMubGVuZ3RoIC0gMSkpO1xuICAgICAgICBwLnBpdGNoQ2xhc3MgPSBQaXRjaENsYXNzW3Muc3Vic3RyaW5nKDAsIHMubGVuZ3RoIC0gMSkucmVwbGFjZSgnIycsICdzJyldO1xuICAgICAgICByZXR1cm4gcDtcbiAgICB9XG5cbn1cbiIsImFic3RyYWN0IGNsYXNzIE91dHB1dCB7XG5cbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoaWQpIHtcbiAgICAgICAgdGhpcy5pZCA9IGlkO1xuICAgIH1cblxuICAgIGFic3RyYWN0IHN0YXJ0KHA6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKTogdm9pZDtcbiAgICBhYnN0cmFjdCBzdG9wKHA6IFBpdGNoKTogdm9pZDtcblxufSIsImNsYXNzIENvbm5lY3RvciB7XG5cbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5wdXRzOiBJbnB1dFtdO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBvdXRwdXRzOiBPdXRwdXRbXTtcblxuXG4gICAgYWRkSW5wdXQoaTogSW5wdXQpIHtcbiAgICAgICAgdGhpcy5pbnB1dHMucHVzaChpKTtcbiAgICAgICAgaS5vblN0YXJ0ID0gKHA6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dHMuZm9yRWFjaChvID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoby5pZCAhPSBpLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIG8uc3RhcnQocCwgdmVsb2NpdHkpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaS5vblN0b3AgPSAocDogUGl0Y2gpID0+IHtcbiAgICAgICAgICAgIHRoaXMub3V0cHV0cy5mb3JFYWNoKG8gPT4ge1xuICAgICAgICAgICAgICAgIGlmIChvLmlkICE9IGkuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgby5zdG9wKHApXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRPdXRwdXQobzogT3V0cHV0KSB7XG4gICAgICAgIHRoaXMub3V0cHV0cy5wdXNoKG8pO1xuICAgIH1cblxufSIsImNsYXNzIEtleWJvYXJkIGV4dGVuZHMgSW5wdXQge1xuXG4gICAgcHJpdmF0ZSBrZXlzID0gJ3pzeGRjdmdiaG5qbXEydzNlcjV0Nnk3dWk5bzBwJztcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigna2V5Ym9hcmQnKTtcbiAgICAgICAgd2luZG93Lm9ua2V5ZG93biA9IGV2dCA9PiB0aGlzLnN0YXJ0KHRoaXMuZm9yS2V5KGV2dC53aGljaCksIE5vdGVzLmRlZmF1bHRWZWxvY2l0eSk7XG4gICAgICAgIHdpbmRvdy5vbmtleXVwID0gZXZ0ID0+IHRoaXMuc3RvcCh0aGlzLmZvcktleShldnQud2hpY2gpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcktleShuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5mb3JOdW1iZXIobik7XG4gICAgfVxuXG59ICIsIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9leHQvd2VibWlkaS5kLnRzXCIgLz5cblxuY2xhc3MgTWlkaU1lc3NhZ2Uge1xuICAgIGNvbW1hbmQ6IG51bWJlcjtcbiAgICBjaGFubmVsOiBudW1iZXI7XG4gICAgdHlwZTogbnVtYmVyO1xuICAgIG5vdGU6IG51bWJlcjtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xufVxuXG5jbGFzcyBNaWRpVXRpbHMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZW5hYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIGluZm86IFdlYk1pZGkuTUlESUFjY2VzcztcbiAgICBzdGF0aWMgb3V0cHV0czogQXJyYXk8V2ViTWlkaS5NSURJT3V0cHV0PjtcbiAgICBzdGF0aWMgaW5wdXRzOiBBcnJheTxXZWJNaWRpLk1JRElJbnB1dD47XG5cbiAgICBzdGF0aWMgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yLnJlcXVlc3RNSURJQWNjZXNzKCkudGhlbihcbiAgICAgICAgICAgICAgICAgICAgeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5mbyA9IHg7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5wdXRzID0gQXJyYXkuZnJvbSh4LmlucHV0cy52YWx1ZXMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMub3V0cHV0cyA9IEFycmF5LmZyb20oeC5vdXRwdXRzLnZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgTWlkaVV0aWxzLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZGVjb2RlKGRhdGE6IFVpbnQ4QXJyYXkpOiBNaWRpTWVzc2FnZSB7XG4gICAgICAgIHZhciBtID0gbmV3IE1pZGlNZXNzYWdlKCk7XG4gICAgICAgIG0uY29tbWFuZCA9IGRhdGFbMF0gPj4gNDtcbiAgICAgICAgbS5jaGFubmVsID0gZGF0YVswXSAmIDB4ZjtcbiAgICAgICAgbS50eXBlID0gZGF0YVswXSAmIDB4ZjA7XG4gICAgICAgIG0ubm90ZSA9IGRhdGFbMV07XG4gICAgICAgIG0udmVsb2NpdHkgPSBkYXRhWzJdO1xuICAgICAgICByZXR1cm4gbTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGVuY29kZShtOiBNaWRpTWVzc2FnZSkge1xuICAgICAgICB2YXIgeCA9IChtLmNoYW5uZWwgJiAweGYpIHwgKG0udHlwZSAmIDB4ZjApIHwgKG0uY29tbWFuZCA8PCA0KTtcbiAgICAgICAgcmV0dXJuIFt4LCBtLm5vdGUsIG0udmVsb2NpdHldO1xuICAgIH07XG5cbiAgICBzdGF0aWMgY3JlYXRlSW5wdXQoaWQ6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaUlucHV0KGlkLCB0aGlzLmlucHV0c1tuXSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZU91dHB1dChpZDogc3RyaW5nLCBuOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBNaWRpT3V0cHV0KGlkLCB0aGlzLm91dHB1dHNbbl0pO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1BpdGNoKGNvZGU6IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIHsgb2N0YXZlOiBNYXRoLnRydW5jKGNvZGUgLyAxMiksIHBpdGNoQ2xhc3M6IGNvZGUgJSAxMiB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tUGl0Y2gocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBwaXRjaC5vY3RhdmUgKiAxMiArIHBpdGNoLnBpdGNoQ2xhc3M7XG4gICAgfVxuXG59XG5cblxuXG5jbGFzcyBNaWRpSW5wdXQgZXh0ZW5kcyBJbnB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dDtcblxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dCkge1xuICAgICAgICBzdXBlcihpZCk7XG4gICAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcblxuICAgICAgICB0aGlzLmlucHV0Lm9ubWlkaW1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgdmFyIG0gPSBNaWRpVXRpbHMuZGVjb2RlKGV2dC5kYXRhKTtcbiAgICAgICAgICAgIHZhciBwaXRjaCA9IE1pZGlVdGlscy50b1BpdGNoKG0ubm90ZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldnQuZGF0YSwgbSwgcGl0Y2gsIE5vdGVzLnRvU3RyaW5nKHBpdGNoKSk7XG4gICAgICAgICAgICBpZiAobS50eXBlID09IDEyOCB8fCAobS50eXBlID09IDE0NCAmJiBtLnZlbG9jaXR5ID09IDApKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wKHBpdGNoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobS50eXBlID09IDE0NCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQocGl0Y2gsIG0udmVsb2NpdHkgLyAxMjcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuXG5jbGFzcyBNaWRpT3V0cHV0IGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQ7XG5cbiAgICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBvdXRwdXQ6IFdlYk1pZGkuTUlESU91dHB1dCkge1xuICAgICAgICBzdXBlcihpZCk7XG4gICAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0O1xuICAgIH1cblxuICAgIHN0YXJ0KHA6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMub3V0cHV0LnNlbmQoTWlkaVV0aWxzLmVuY29kZSh7IC8vXG4gICAgICAgICAgICBjb21tYW5kOiA5LCAvL1xuICAgICAgICAgICAgY2hhbm5lbDogMCwgLy9cbiAgICAgICAgICAgIHR5cGU6IDE0NCwgLy9cbiAgICAgICAgICAgIG5vdGU6IE1pZGlVdGlscy5mcm9tUGl0Y2gocCksIC8vIFxuICAgICAgICAgICAgdmVsb2NpdHk6IE1hdGgudHJ1bmModmVsb2NpdHkgKiAxMjcpIC8vIFxuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgc3RvcChwOiBQaXRjaCkge1xuICAgICAgICB0aGlzLm91dHB1dC5zZW5kKE1pZGlVdGlscy5lbmNvZGUoeyAvL1xuICAgICAgICAgICAgY29tbWFuZDogOSwgLy9cbiAgICAgICAgICAgIGNoYW5uZWw6IDAsIC8vXG4gICAgICAgICAgICB0eXBlOiAxNDQsIC8vXG4gICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKHApLCAvLyBcbiAgICAgICAgICAgIHZlbG9jaXR5OiAwXG4gICAgICAgIH0pKTtcbiAgICB9XG5cbn0iLCJ0eXBlIFdhdmVUeXBlID0gJ3NpbmUnIHwgJ3NxdWFyZScgfCAnc2F3dG9vdGgnIHwgJ3RyaWFuZ2xlJztcblxuY2xhc3MgT3NjaWxsYXRvciBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG9zYzogT3NjaWxsYXRvck5vZGU7XG5cbiAgICBjb25zdHJ1Y3Rvcih0eXBlOiBXYXZlVHlwZSkge1xuICAgICAgICBzdXBlcignb3NjaWxsYXRvcicpO1xuICAgICAgICB2YXIgY3R4ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICAgICAgICB0aGlzLm9zYyA9IGN0eC5jcmVhdGVPc2NpbGxhdG9yKCk7XG4gICAgICAgIHRoaXMub3NjLnR5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLm9zYy5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7XG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoLCB2ZWxvY2l0eTpudW1iZXIpIHtcbiAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KHBpdGNoKTtcbiAgICAgICAgdGhpcy5vc2Muc3RhcnQoKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLm9zYy5zdG9wKCk7XG4gICAgfVxuXG59IiwiY2xhc3MgT3V0cHV0Q2hvcnVzIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0OiBhbnk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZWxheTogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVjYXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRpbWVzOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihpZCwgb3V0cHV0OiBPdXRwdXQsIGRlbGF5OiBudW1iZXIsIGRlY2F5OiBudW1iZXIsIHRpbWVzOiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICAgICAgdGhpcy5kZWxheSA9IGRlbGF5O1xuICAgICAgICB0aGlzLmRlY2F5ID0gZGVjYXk7XG4gICAgICAgIHRoaXMudGltZXMgPSB0aW1lcztcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gsIHZlbG9jaXR5KSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50aW1lczsgaSsrKSB7XG4gICAgICAgICAgICB2ZWxvY2l0eSAqPSB0aGlzLmRlY2F5O1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm91dHB1dC5zdGFydChwaXRjaCwgdmVsb2NpdHksIHRoaXMuZGVsYXkgKiAoaSArIDEpKSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHN0b3AocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RvcChwaXRjaCksIHRoaXMuZGVsYXkgKiAodGhpcy50aW1lcyArIDEpKTtcbiAgICB9XG5cbn0iLCJcbmNsYXNzIFBpYW5vS2V5Ym9hcmQgZXh0ZW5kcyBPdXRwdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGtleXM6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZpcnN0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSB3aGl0ZUtleVdpZHRoOiBudW1iZXI7XG5cblxuICAgIGNvbnN0cnVjdG9yKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBmaXJzdDogUGl0Y2gsIGxhc3Q6IFBpdGNoKSB7XG4gICAgICAgIHN1cGVyKCdwaWFub0tleWJvYXJkJyk7XG4gICAgICAgIHRoaXMuZmlyc3QgPSBOb3Rlcy5hc051bWJlcihmaXJzdCk7XG4gICAgICAgIHRoaXMua2V5cyA9IE5vdGVzLmFzTnVtYmVyKGxhc3QpIC0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpICsgMTtcbiAgICAgICAgdGhpcy53aGl0ZUtleVdpZHRoID0gTWF0aC50cnVuYyh3aWR0aCAvIHRoaXMua2V5cyk7XG5cbiAgICAgICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB3aWR0aDtcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZS5ib3JkZXIgPSAnM3B4IHNvbGlkJztcbiAgICAgICAgdGhpcy5jdHggPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpICE7XG4gICAgICAgIHRoaXMuZHJhd0tleXMoKTtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNhbnZhcyk7XG5cbiAgICAgICAgdGhpcy5jYW52YXMub25jbGljayA9IGV2dCA9PiBjb25zb2xlLmxvZyhldnQpXG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHRoaXMuZHJhd1ByZXNzZWQocGl0Y2gsICdyZWQnKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLmRyYXdQcmVzc2VkKHBpdGNoLCAnd2hpdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRyYXdLZXlzKCkge1xuICAgICAgICB0aGlzLmN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgICAgIHRoaXMuY3R4LmxpbmVXaWR0aCA9IDI7XG4gICAgICAgIHRoaXMuY3R4LnN0cm9rZVN0eWxlID0gJ2JsYWNrJztcbiAgICAgICAgZm9yICh2YXIga2V5ID0gMDsga2V5IDwgdGhpcy5rZXlzOyBrZXkrKykge1xuICAgICAgICAgICAgdmFyIHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoO1xuICAgICAgICAgICAgdGhpcy5jdHgucmVjdChzdGFydCwgMCwgdGhpcy53aGl0ZUtleVdpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCB0aGlzLndoaXRlS2V5V2lkdGgsIHRoaXMua2V5cyAqIHRoaXMud2hpdGVLZXlXaWR0aCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jdHguc3Ryb2tlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3UHJlc3NlZChwOiBQaXRjaCwgY29sb3I6IHN0cmluZykge1xuICAgICAgICBsZXQgbiA9IE5vdGVzLmFzTnVtYmVyKHApIC0gdGhpcy5maXJzdDtcbiAgICAgICAgbGV0IGNlbnRlciA9IChuICsgMC41KSAqIHRoaXMud2hpdGVLZXlXaWR0aDtcbiAgICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIHRoaXMuY3R4LmxpbmVXaWR0aCA9IDA7XG4gICAgICAgIHRoaXMuY3R4LmFyYyhjZW50ZXIsIHRoaXMuY2FudmFzLmhlaWdodCAqIDAuOCwgdGhpcy53aGl0ZUtleVdpZHRoICogMC4zLCAwLCAyICogTWF0aC5QSSwgZmFsc2UpO1xuICAgICAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSBjb2xvcjtcbiAgICAgICAgdGhpcy5jdHguZmlsbCgpO1xuICAgIH1cblxufSIsImVudW0gUGl0Y2hDbGFzcyB7XG4gICAgQywgQ3MsIEQsIERzLCBFLCBGLCBGcywgRywgR3MsIEEsIEFzLCBCXG59XG5cbmVudW0gQWNjaWRlbnRhbCB7XG4gICAgTmF0dXJhbCwgU2hhcnAsIEZsYXRcbn1cblxuZW51bSBEdXJhdGlvblR5cGUge1xuICAgIFJlYWwsIFNoZWV0XG59XG5cbmNsYXNzIFBpdGNoIHtcbiAgICBwaXRjaENsYXNzOiBQaXRjaENsYXNzO1xuICAgIG9jdGF2ZTogbnVtYmVyO1xufVxuXG5jbGFzcyBOb3RlIHtcbiAgICBwaXRjaDogUGl0Y2g7XG4gICAgdmVsb2NpdHk6IG51bWJlcjtcbiAgICBkdXJhdGlvbjogbnVtYmVyIHwgbnVsbDtcbn0iLCIiXX0=