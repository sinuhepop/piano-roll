document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        let connector = new Connector();
        connector.addOutput(new Logger());
        let piano = new PianoKeyboard({ width: 1232, height: 200 }, Notes.fromString('A1'), Notes.fromString('C9'));
        connector.addInput(piano);
        connector.addOutput(piano);
        if (MidiUtils.inputs.length > 0) {
            connector.addInput(MidiUtils.createInput('midi', 0));
            connector.addOutput(MidiUtils.createOutput('midi', 0));
        }
    });
});
class Input {
    constructor(id) {
        this.id = id;
    }
    send(m) {
        if (this.onSend != null) {
            this.onSend(m);
        }
    }
}
class Notes {
    static latinName(p) {
        return Notes.latinNames[p];
    }
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.pitchClass;
    }
    static forNumber(n) {
        return { octave: n / 12 + 4, pitchClass: n % 12 };
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
    static toString(p) {
        return PitchClass[p.pitchClass].replace('s', '#') + p.octave;
    }
    static fromString(s) {
        var p = new Pitch();
        p.octave = parseInt(s.substring(s.length - 1));
        p.pitchClass = PitchClass[s.substring(0, s.length - 1).replace('#', 's')];
        return p;
    }
}
Notes.defaultVelocity = 0.7;
Notes.latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
class Output {
    constructor(id) {
        this.id = id;
    }
}
var PitchClass;
(function (PitchClass) {
    PitchClass[PitchClass["C"] = 0] = "C";
    PitchClass[PitchClass["Cs"] = 1] = "Cs";
    PitchClass[PitchClass["D"] = 2] = "D";
    PitchClass[PitchClass["Ds"] = 3] = "Ds";
    PitchClass[PitchClass["E"] = 4] = "E";
    PitchClass[PitchClass["F"] = 5] = "F";
    PitchClass[PitchClass["Fs"] = 6] = "Fs";
    PitchClass[PitchClass["G"] = 7] = "G";
    PitchClass[PitchClass["Gs"] = 8] = "Gs";
    PitchClass[PitchClass["A"] = 9] = "A";
    PitchClass[PitchClass["As"] = 10] = "As";
    PitchClass[PitchClass["B"] = 11] = "B";
})(PitchClass || (PitchClass = {}));
var Accidental;
(function (Accidental) {
    Accidental[Accidental["Natural"] = 0] = "Natural";
    Accidental[Accidental["Sharp"] = 1] = "Sharp";
    Accidental[Accidental["Flat"] = 2] = "Flat";
})(Accidental || (Accidental = {}));
var DurationType;
(function (DurationType) {
    DurationType[DurationType["Real"] = 0] = "Real";
    DurationType[DurationType["Sheet"] = 1] = "Sheet";
})(DurationType || (DurationType = {}));
class Pitch {
}
class Note {
}
class Connector {
    constructor() {
        this.inputs = [];
        this.outputs = [];
    }
    addInput(i) {
        this.inputs.push(i);
        i.onSend = (m) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.receive(m);
                }
            });
        };
    }
    addOutput(o) {
        this.outputs.push(o);
    }
}
class Keyboard extends Input {
    constructor() {
        super('keyboard');
        this.velocity = Notes.defaultVelocity;
        this.channel = 1;
        window.onkeydown = evt => this.send({
            type: 'start',
            pitch: this.forKey(evt.which),
            velocity: this.velocity,
            channel: this.channel
        });
        window.onkeyup = evt => this.send({
            type: 'stop',
            pitch: this.forKey(evt.which)
        });
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="../ext/webmidi.d.ts" />
class MidiMessage {
}
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n) {
        return new MidiInput(id, this.inputs[n]);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return { octave: Math.trunc(code / 12), pitchClass: code % 12 };
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.pitchClass;
    }
}
MidiUtils.enabled = false;
class MidiInput extends Input {
    constructor(id, input) {
        super(id);
        this.input = input;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                this.send({
                    type: 'stop',
                    pitch: pitch
                });
            }
            else if (m.type == 144) {
                this.send({
                    type: 'start',
                    pitch: pitch,
                    velocity: m.velocity / 127,
                    channel: 1
                });
            }
        };
    }
}
class MidiOutput extends Output {
    constructor(id, output) {
        super(id);
        this.output = output;
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: Math.trunc(m.velocity * 127) // 
            }));
            case 'stop': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: 0
            }));
        }
    }
}
class Oscillator extends Output {
    constructor(type) {
        super('oscillator');
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch, velocity) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                this.osc.frequency.value = Notes.frequency(m.pitch);
                this.osc.start();
                break;
            case 'stop':
                this.osc.stop();
                break;
        }
    }
}
class OutputChorus extends Output {
    constructor(id, output, delay, decay, times) {
        super(id);
        this.output = output;
        this.delay = delay;
        this.decay = decay;
        this.times = times;
    }
    start(pitch, velocity) {
        for (var i = 0; i < this.times; i++) {
            velocity *= this.decay;
            setTimeout(() => this.output.start(pitch, velocity, this.delay * (i + 1)));
        }
    }
    stop(pitch) {
        setTimeout(() => this.output.stop(pitch), this.delay * (this.times + 1));
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                let velocity = m.velocity;
                for (let i = 0; i < this.times; i++) {
                    velocity *= this.decay;
                    setTimeout(() => this.output.start(m.pitch, velocity, this.delay * (i + 1)));
                }
                break;
            case 'stop':
                setTimeout(() => this.output.stop(m.pitch), this.delay * (this.times + 1));
                break;
        }
    }
}
class PianoKeyboard extends Input {
    constructor(dim, first, last) {
        super('pianoKeyboard');
        this.keysPainted = [];
        this.dim = dim;
        this.canvas = Snap(dim.width, dim.height);
        this.firstKey = Notes.asNumber(first);
        this.keyLength = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(dim.width / this.keyLength);
        this.blackKeyWidth = this.whiteKeyWidth * 0.7;
        this.drawKeys();
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.drawPressed(m.pitch, 'red');
            case 'stop': return this.drawPressed(m.pitch, 'white');
        }
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        var attrs = { fill: '#fff', stroke: '#000', strokeWidth: 1 };
        for (let key = 0; key < this.keyLength; key++) {
            let start = key * this.whiteKeyWidth;
            let rect = this.canvas.rect(start, 0, this.whiteKeyWidth, this.dim.height);
            rect.attr(attrs);
            this.keysPainted.push(rect);
            rect.data('key', key);
            rect.click((event) => {
                this.send({
                    type: 'start',
                    pitch: Notes.forNumber(key + this.firstKey),
                    velocity: 0.7,
                    channel: 1
                });
            });
        }
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.firstKey;
        let key = this.keysPainted[n];
        key.attr({ fill: color });
    }
}
PianoKeyboard.blackKeyWidth = 0.58;
class Logger extends Output {
    constructor() {
        super('logger');
    }
    receive(m) {
        console.log(Notes.toString(m.pitch), m);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvaW5wdXQudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvbm90ZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvb3V0cHV0LnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL21lc3NhZ2VzLnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL3R5cGVzLnRzIiwiLi4vdHlwZXNjcmlwdC9pbXBsL0Nvbm5lY3Rvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvT3NjaWxsYXRvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9PdXRwdXRDaG9ydXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9Mb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFO0lBQzFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFFeEIsSUFBSSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUVoQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQztRQUVsQyxJQUFJLEtBQUssR0FBRyxJQUFJLGFBQWEsQ0FDekIsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFDNUIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFDdEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FDekIsQ0FBQztRQUNGLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUIsU0FBUyxDQUFDLFNBQVMsQ0FB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QUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5QixDQUFDOztBQWhFdUIsMkJBQWEsR0FBRyxJQUFJLENBQUM7QUNIakQsWUFBYSxTQUFRLE1BQU07SUFFdkI7UUFDSSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVELE9BQU8sQ0FBQyxDQUFVO1FBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gICAgTWlkaVV0aWxzLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcblxuICAgICAgICBsZXQgY29ubmVjdG9yID0gbmV3IENvbm5lY3RvcigpO1xuICAgICAgICBcbiAgICAgICAgY29ubmVjdG9yLmFkZE91dHB1dChuZXcgTG9nZ2VyKCkpO1xuXG4gICAgICAgIGxldCBwaWFubyA9IG5ldyBQaWFub0tleWJvYXJkKFxuICAgICAgICAgICAgeyB3aWR0aDogMTIzMiwgaGVpZ2h0OiAyMDAgfSxcbiAgICAgICAgICAgIE5vdGVzLmZyb21TdHJpbmcoJ0ExJyksXG4gICAgICAgICAgICBOb3Rlcy5mcm9tU3RyaW5nKCdDOScpXG4gICAgICAgICk7XG4gICAgICAgIGNvbm5lY3Rvci5hZGRJbnB1dChwaWFubyk7XG4gICAgICAgIGNvbm5lY3Rvci5hZGRPdXRwdXQocGlhbm8pO1xuXG4gICAgICAgIGlmIChNaWRpVXRpbHMuaW5wdXRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbm5lY3Rvci5hZGRJbnB1dChNaWRpVXRpbHMuY3JlYXRlSW5wdXQoJ21pZGknLCAwKSk7XG4gICAgICAgICAgICBjb25uZWN0b3IuYWRkT3V0cHV0KE1pZGlVdGlscy5jcmVhdGVPdXRwdXQoJ21pZGknLCAwKSk7XG4gICAgICAgIH1cbiAgICB9KTtcbn0pOyIsImFic3RyYWN0IGNsYXNzIElucHV0IHtcblxuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gICAgb25TZW5kOiAoKG06IE1lc3NhZ2UpID0+IGFueSkgfCBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNlbmQobTogTWVzc2FnZSkge1xuICAgICAgICBpZiAodGhpcy5vblNlbmQgIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5vblNlbmQobSk7XG4gICAgICAgIH1cbiAgICB9XG5cbn0iLCJhYnN0cmFjdCBjbGFzcyBOb3RlcyB7XG5cbiAgICBzdGF0aWMgcmVhZG9ubHkgZGVmYXVsdFZlbG9jaXR5ID0gMC43O1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgbGF0aW5OYW1lcyA9IFsnRG8nLCAnRG8jJywgJ1JlJywgJ1JlIycsICdNaScsICdGYScsICdGYSMnLCAnU29sJywgJ1NvbCMnLCAnTGEnLCAnTGEjJywgJ1NpJ107XG5cblxuICAgIHN0YXRpYyBsYXRpbk5hbWUocDogUGl0Y2hDbGFzcyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5sYXRpbk5hbWVzW3BdO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc051bWJlcihwOiBQaXRjaCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAocC5vY3RhdmUgLSA0KSAqIDEyICsgcC5waXRjaENsYXNzO1xuICAgIH1cblxuICAgIHN0YXRpYyBmb3JOdW1iZXIobjogbnVtYmVyKTogUGl0Y2gge1xuICAgICAgICByZXR1cm4geyBvY3RhdmU6IG4gLyAxMiArIDQsIHBpdGNoQ2xhc3M6IG4gJSAxMiB9XG4gICAgfVxuXG4gICAgc3RhdGljIGZyZXF1ZW5jeShwOiBQaXRjaCkge1xuICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgKE5vdGVzLmFzTnVtYmVyKHApIC0gNDkpIC8gMTIpICogNDQwO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1N0cmluZyhwOiBQaXRjaCkge1xuICAgICAgICByZXR1cm4gUGl0Y2hDbGFzc1twLnBpdGNoQ2xhc3NdLnJlcGxhY2UoJ3MnLCAnIycpICsgcC5vY3RhdmU7XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21TdHJpbmcoczogc3RyaW5nKSB7XG4gICAgICAgIHZhciBwID0gbmV3IFBpdGNoKCk7XG4gICAgICAgIHAub2N0YXZlID0gcGFyc2VJbnQocy5zdWJzdHJpbmcocy5sZW5ndGggLSAxKSk7XG4gICAgICAgIHAucGl0Y2hDbGFzcyA9IFBpdGNoQ2xhc3Nbcy5zdWJzdHJpbmcoMCwgcy5sZW5ndGggLSAxKS5yZXBsYWNlKCcjJywgJ3MnKV07XG4gICAgICAgIHJldHVybiBwO1xuICAgIH1cblxufVxuIiwiYWJzdHJhY3QgY2xhc3MgT3V0cHV0IHtcblxuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihpZCkge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgYWJzdHJhY3QgcmVjZWl2ZShtOiBNZXNzYWdlKTogdm9pZDtcblxufSIsInR5cGUgTWVzc2FnZSA9XG4gICAge1xuICAgICAgICB0eXBlOiAnc3RhcnQnLFxuICAgICAgICBwaXRjaDogUGl0Y2gsXG4gICAgICAgIGNoYW5uZWw6IG51bWJlcixcbiAgICAgICAgdmVsb2NpdHk6IG51bWJlclxuICAgIH0gfCB7XG4gICAgICAgIHR5cGU6ICdzdG9wJyxcbiAgICAgICAgcGl0Y2g6IFBpdGNoXG4gICAgfTsiLCJlbnVtIFBpdGNoQ2xhc3Mge1xuICAgIEMsIENzLCBELCBEcywgRSwgRiwgRnMsIEcsIEdzLCBBLCBBcywgQlxufVxuXG5lbnVtIEFjY2lkZW50YWwge1xuICAgIE5hdHVyYWwsIFNoYXJwLCBGbGF0XG59XG5cbmVudW0gRHVyYXRpb25UeXBlIHtcbiAgICBSZWFsLCBTaGVldFxufVxuXG5jbGFzcyBQaXRjaCB7XG4gICAgcGl0Y2hDbGFzczogUGl0Y2hDbGFzcztcbiAgICBvY3RhdmU6IG51bWJlcjtcbn1cblxuY2xhc3MgTm90ZSB7XG4gICAgcGl0Y2g6IFBpdGNoO1xuICAgIHZlbG9jaXR5OiBudW1iZXI7XG4gICAgZHVyYXRpb246IG51bWJlciB8IG51bGw7XG59XG5cbnR5cGUgRGltZW5zaW9ucyA9IHsgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIgfTtcblxuXG4iLCJjbGFzcyBDb25uZWN0b3Ige1xuXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGlucHV0czogSW5wdXRbXSA9IFtdO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBvdXRwdXRzOiBPdXRwdXRbXSA9IFtdO1xuXG4gICAgYWRkSW5wdXQoaTogSW5wdXQpIHtcbiAgICAgICAgdGhpcy5pbnB1dHMucHVzaChpKTtcbiAgICAgICAgaS5vblNlbmQgPSAobTogTWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXRzLmZvckVhY2gobyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG8uaWQgIT0gaS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBvLnJlY2VpdmUobSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRPdXRwdXQobzogT3V0cHV0KSB7XG4gICAgICAgIHRoaXMub3V0cHV0cy5wdXNoKG8pO1xuICAgIH1cblxufSIsImNsYXNzIEtleWJvYXJkIGV4dGVuZHMgSW5wdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlzOiAnenN4ZGN2Z2JobmptcTJ3M2VyNXQ2eTd1aTlvMHAnO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdmVsb2NpdHk6IG51bWJlciA9IE5vdGVzLmRlZmF1bHRWZWxvY2l0eTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNoYW5uZWw6IG51bWJlciA9IDE7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoJ2tleWJvYXJkJyk7XG5cbiAgICAgICAgd2luZG93Lm9ua2V5ZG93biA9IGV2dCA9PiB0aGlzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ3N0YXJ0JyxcbiAgICAgICAgICAgIHBpdGNoOiB0aGlzLmZvcktleShldnQud2hpY2gpLFxuICAgICAgICAgICAgdmVsb2NpdHk6IHRoaXMudmVsb2NpdHksXG4gICAgICAgICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWxcbiAgICAgICAgfSk7XG4gICAgICAgIHdpbmRvdy5vbmtleXVwID0gZXZ0ID0+IHRoaXMuc2VuZCh7XG4gICAgICAgICAgICB0eXBlOiAnc3RvcCcsXG4gICAgICAgICAgICBwaXRjaDogdGhpcy5mb3JLZXkoZXZ0LndoaWNoKVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcktleShuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5mb3JOdW1iZXIobik7XG4gICAgfVxuXG59ICIsIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9leHQvd2VibWlkaS5kLnRzXCIgLz5cblxuY2xhc3MgTWlkaU1lc3NhZ2Uge1xuICAgIGNvbW1hbmQ6IG51bWJlcjtcbiAgICBjaGFubmVsOiBudW1iZXI7XG4gICAgdHlwZTogbnVtYmVyO1xuICAgIG5vdGU6IG51bWJlcjtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xufVxuXG5jbGFzcyBNaWRpVXRpbHMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZW5hYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIGluZm86IFdlYk1pZGkuTUlESUFjY2VzcztcbiAgICBzdGF0aWMgb3V0cHV0czogQXJyYXk8V2ViTWlkaS5NSURJT3V0cHV0PjtcbiAgICBzdGF0aWMgaW5wdXRzOiBBcnJheTxXZWJNaWRpLk1JRElJbnB1dD47XG5cbiAgICBzdGF0aWMgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yLnJlcXVlc3RNSURJQWNjZXNzKCkudGhlbihcbiAgICAgICAgICAgICAgICAgICAgeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5mbyA9IHg7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5wdXRzID0gQXJyYXkuZnJvbSh4LmlucHV0cy52YWx1ZXMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMub3V0cHV0cyA9IEFycmF5LmZyb20oeC5vdXRwdXRzLnZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgTWlkaVV0aWxzLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZGVjb2RlKGRhdGE6IFVpbnQ4QXJyYXkpOiBNaWRpTWVzc2FnZSB7XG4gICAgICAgIHZhciBtID0gbmV3IE1pZGlNZXNzYWdlKCk7XG4gICAgICAgIG0uY29tbWFuZCA9IGRhdGFbMF0gPj4gNDtcbiAgICAgICAgbS5jaGFubmVsID0gZGF0YVswXSAmIDB4ZjtcbiAgICAgICAgbS50eXBlID0gZGF0YVswXSAmIDB4ZjA7XG4gICAgICAgIG0ubm90ZSA9IGRhdGFbMV07XG4gICAgICAgIG0udmVsb2NpdHkgPSBkYXRhWzJdO1xuICAgICAgICByZXR1cm4gbTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGVuY29kZShtOiBNaWRpTWVzc2FnZSkge1xuICAgICAgICB2YXIgeCA9IChtLmNoYW5uZWwgJiAweGYpIHwgKG0udHlwZSAmIDB4ZjApIHwgKG0uY29tbWFuZCA8PCA0KTtcbiAgICAgICAgcmV0dXJuIFt4LCBtLm5vdGUsIG0udmVsb2NpdHldO1xuICAgIH07XG5cbiAgICBzdGF0aWMgY3JlYXRlSW5wdXQoaWQ6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaUlucHV0KGlkLCB0aGlzLmlucHV0c1tuXSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZU91dHB1dChpZDogc3RyaW5nLCBuOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBNaWRpT3V0cHV0KGlkLCB0aGlzLm91dHB1dHNbbl0pO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1BpdGNoKGNvZGU6IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIHsgb2N0YXZlOiBNYXRoLnRydW5jKGNvZGUgLyAxMiksIHBpdGNoQ2xhc3M6IGNvZGUgJSAxMiB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tUGl0Y2gocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBwaXRjaC5vY3RhdmUgKiAxMiArIHBpdGNoLnBpdGNoQ2xhc3M7XG4gICAgfVxuXG59XG5cblxuXG5jbGFzcyBNaWRpSW5wdXQgZXh0ZW5kcyBJbnB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dDtcblxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dCkge1xuICAgICAgICBzdXBlcihpZCk7XG4gICAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcblxuICAgICAgICB0aGlzLmlucHV0Lm9ubWlkaW1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgdmFyIG0gPSBNaWRpVXRpbHMuZGVjb2RlKGV2dC5kYXRhKTtcbiAgICAgICAgICAgIHZhciBwaXRjaCA9IE1pZGlVdGlscy50b1BpdGNoKG0ubm90ZSk7XG4gICAgICAgICAgICBpZiAobS50eXBlID09IDEyOCB8fCAobS50eXBlID09IDE0NCAmJiBtLnZlbG9jaXR5ID09IDApKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3N0b3AnLFxuICAgICAgICAgICAgICAgICAgICBwaXRjaDogcGl0Y2hcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobS50eXBlID09IDE0NCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFydCcsXG4gICAgICAgICAgICAgICAgICAgIHBpdGNoOiBwaXRjaCxcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG0udmVsb2NpdHkgLyAxMjcsXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgTWlkaU91dHB1dCBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogV2ViTWlkaS5NSURJT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICB9XG5cbiAgICByZWNlaXZlKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChtLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0JzogcmV0dXJuIHRoaXMub3V0cHV0LnNlbmQoTWlkaVV0aWxzLmVuY29kZSh7IC8vXG4gICAgICAgICAgICAgICAgY29tbWFuZDogOSwgLy9cbiAgICAgICAgICAgICAgICBjaGFubmVsOiAwLCAvL1xuICAgICAgICAgICAgICAgIHR5cGU6IDE0NCwgLy9cbiAgICAgICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKG0ucGl0Y2gpLCAvLyBcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogTWF0aC50cnVuYyhtLnZlbG9jaXR5ICogMTI3KSAvLyBcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIGNhc2UgJ3N0b3AnOiByZXR1cm4gdGhpcy5vdXRwdXQuc2VuZChNaWRpVXRpbHMuZW5jb2RlKHsgLy9cbiAgICAgICAgICAgICAgICBjb21tYW5kOiA5LFxuICAgICAgICAgICAgICAgIGNoYW5uZWw6IDAsXG4gICAgICAgICAgICAgICAgdHlwZTogMTQ0LFxuICAgICAgICAgICAgICAgIG5vdGU6IE1pZGlVdGlscy5mcm9tUGl0Y2gobS5waXRjaCksXG4gICAgICAgICAgICAgICAgdmVsb2NpdHk6IDBcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxufSIsInR5cGUgV2F2ZVR5cGUgPSAnc2luZScgfCAnc3F1YXJlJyB8ICdzYXd0b290aCcgfCAndHJpYW5nbGUnO1xuXG5jbGFzcyBPc2NpbGxhdG9yIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3NjOiBPc2NpbGxhdG9yTm9kZTtcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFdhdmVUeXBlKSB7XG4gICAgICAgIHN1cGVyKCdvc2NpbGxhdG9yJyk7XG4gICAgICAgIHZhciBjdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gICAgICAgIHRoaXMub3NjID0gY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTtcbiAgICAgICAgdGhpcy5vc2MudHlwZSA9IHR5cGU7XG4gICAgICAgIHRoaXMub3NjLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTtcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gsIHZlbG9jaXR5OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KHBpdGNoKTtcbiAgICAgICAgdGhpcy5vc2Muc3RhcnQoKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLm9zYy5zdG9wKCk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIHN3aXRjaCAobS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdGFydCc6XG4gICAgICAgICAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KG0ucGl0Y2gpO1xuICAgICAgICAgICAgICAgIHRoaXMub3NjLnN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdzdG9wJzogdGhpcy5vc2Muc3RvcCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG59IiwiY2xhc3MgT3V0cHV0Q2hvcnVzIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0OiBhbnk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZWxheTogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVjYXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRpbWVzOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihpZCwgb3V0cHV0OiBPdXRwdXQsIGRlbGF5OiBudW1iZXIsIGRlY2F5OiBudW1iZXIsIHRpbWVzOiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICAgICAgdGhpcy5kZWxheSA9IGRlbGF5O1xuICAgICAgICB0aGlzLmRlY2F5ID0gZGVjYXk7XG4gICAgICAgIHRoaXMudGltZXMgPSB0aW1lcztcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gsIHZlbG9jaXR5KSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50aW1lczsgaSsrKSB7XG4gICAgICAgICAgICB2ZWxvY2l0eSAqPSB0aGlzLmRlY2F5O1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm91dHB1dC5zdGFydChwaXRjaCwgdmVsb2NpdHksIHRoaXMuZGVsYXkgKiAoaSArIDEpKSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHN0b3AocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RvcChwaXRjaCksIHRoaXMuZGVsYXkgKiAodGhpcy50aW1lcyArIDEpKTtcbiAgICB9XG5cbiAgICByZWNlaXZlKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChtLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0JzpcbiAgICAgICAgICAgICAgICBsZXQgdmVsb2NpdHkgPSBtLnZlbG9jaXR5O1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy50aW1lczsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5ICo9IHRoaXMuZGVjYXk7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RhcnQobS5waXRjaCwgdmVsb2NpdHksIHRoaXMuZGVsYXkgKiAoaSArIDEpKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnc3RvcCc6XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm91dHB1dC5zdG9wKG0ucGl0Y2gpLCB0aGlzLmRlbGF5ICogKHRoaXMudGltZXMgKyAxKSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbn0iLCJcbmNsYXNzIFBpYW5vS2V5Ym9hcmQgZXh0ZW5kcyBJbnB1dCBpbXBsZW1lbnRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBibGFja0tleVdpZHRoID0gMC41ODtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGltOiBEaW1lbnNpb25zO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBTbmFwLlBhcGVyO1xuXG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGtleUxlbmd0aDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZmlyc3RLZXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHdoaXRlS2V5V2lkdGg6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJsYWNrS2V5V2lkdGg6IG51bWJlcjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkga2V5c1BhaW50ZWQ6IEFycmF5PFNuYXAuRWxlbWVudD4gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKGRpbTogRGltZW5zaW9ucywgZmlyc3Q6IFBpdGNoLCBsYXN0OiBQaXRjaCkge1xuICAgICAgICBzdXBlcigncGlhbm9LZXlib2FyZCcpO1xuXG4gICAgICAgIHRoaXMuZGltID0gZGltO1xuICAgICAgICB0aGlzLmNhbnZhcyA9IFNuYXAoZGltLndpZHRoLCBkaW0uaGVpZ2h0KTtcblxuXG4gICAgICAgIHRoaXMuZmlyc3RLZXkgPSBOb3Rlcy5hc051bWJlcihmaXJzdCk7XG4gICAgICAgIHRoaXMua2V5TGVuZ3RoID0gTm90ZXMuYXNOdW1iZXIobGFzdCkgLSBOb3Rlcy5hc051bWJlcihmaXJzdCkgKyAxO1xuXG4gICAgICAgIHRoaXMud2hpdGVLZXlXaWR0aCA9IE1hdGgudHJ1bmMoZGltLndpZHRoIC8gdGhpcy5rZXlMZW5ndGgpO1xuICAgICAgICB0aGlzLmJsYWNrS2V5V2lkdGggPSB0aGlzLndoaXRlS2V5V2lkdGggKiAwLjc7XG5cbiAgICAgICAgdGhpcy5kcmF3S2V5cygpO1xuICAgIH1cblxuICAgIHJlY2VpdmUobTogTWVzc2FnZSkge1xuICAgICAgICBzd2l0Y2ggKG0udHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnc3RhcnQnOiByZXR1cm4gdGhpcy5kcmF3UHJlc3NlZChtLnBpdGNoLCAncmVkJyk7XG4gICAgICAgICAgICBjYXNlICdzdG9wJzogcmV0dXJuIHRoaXMuZHJhd1ByZXNzZWQobS5waXRjaCwgJ3doaXRlJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLmRyYXdQcmVzc2VkKHBpdGNoLCAnd2hpdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRyYXdLZXlzKCkge1xuICAgICAgICB2YXIgYXR0cnMgPSB7IGZpbGw6ICcjZmZmJywgc3Ryb2tlOiAnIzAwMCcsIHN0cm9rZVdpZHRoOiAxIH07XG4gICAgICAgIGZvciAobGV0IGtleSA9IDA7IGtleSA8IHRoaXMua2V5TGVuZ3RoOyBrZXkrKykge1xuICAgICAgICAgICAgbGV0IHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoO1xuICAgICAgICAgICAgbGV0IHJlY3QgPSB0aGlzLmNhbnZhcy5yZWN0KHN0YXJ0LCAwLCB0aGlzLndoaXRlS2V5V2lkdGgsIHRoaXMuZGltLmhlaWdodCk7XG4gICAgICAgICAgICByZWN0LmF0dHIoYXR0cnMpO1xuICAgICAgICAgICAgdGhpcy5rZXlzUGFpbnRlZC5wdXNoKHJlY3QpO1xuICAgICAgICAgICAgcmVjdC5kYXRhKCdrZXknLCBrZXkpO1xuXG4gICAgICAgICAgICByZWN0LmNsaWNrKChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFydCcsXG4gICAgICAgICAgICAgICAgICAgIHBpdGNoOiBOb3Rlcy5mb3JOdW1iZXIoa2V5ICsgdGhpcy5maXJzdEtleSksXG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiAwLjcsXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3UHJlc3NlZChwOiBQaXRjaCwgY29sb3I6IHN0cmluZykge1xuICAgICAgICBsZXQgbiA9IE5vdGVzLmFzTnVtYmVyKHApIC0gdGhpcy5maXJzdEtleTtcbiAgICAgICAgbGV0IGtleSA9IHRoaXMua2V5c1BhaW50ZWRbbl07XG4gICAgICAgIGtleS5hdHRyKHsgZmlsbDogY29sb3IgfSk7XG4gICAgfVxuXG59IiwiY2xhc3MgTG9nZ2VyIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcignbG9nZ2VyJyk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKE5vdGVzLnRvU3RyaW5nKG0ucGl0Y2gpLCBtKTtcbiAgICB9XG5cbn0iXX0=