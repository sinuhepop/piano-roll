document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        var output = new PianoKeyboard(1232, 150, Notes.fromString('A1'), Notes.fromString('C9'));
        if (MidiUtils.inputs.length > 0) {
            var input = MidiUtils.createInput('defaultMidi', 0, output);
        }
        window['output'] = output;
        window['piano'] = MidiUtils.createOutput('piano', 0);
    });
});
class Chorus {
    constructor(output, delay) {
        this.output = output;
        this.delay = delay;
    }
    start(pitch) {
        setTimeout(() => {
            this.output.start(pitch);
        }, this.delay);
    }
    ;
    stop(pitch) {
        setTimeout(() => {
            this.output.stop(pitch);
        }, this.delay);
    }
    ;
}
var PitchClass;
(function (PitchClass) {
    PitchClass[PitchClass["C"] = 0] = "C";
    PitchClass[PitchClass["Cs"] = 1] = "Cs";
    PitchClass[PitchClass["D"] = 2] = "D";
    PitchClass[PitchClass["Ds"] = 3] = "Ds";
    PitchClass[PitchClass["E"] = 4] = "E";
    PitchClass[PitchClass["F"] = 5] = "F";
    PitchClass[PitchClass["Fs"] = 6] = "Fs";
    PitchClass[PitchClass["G"] = 7] = "G";
    PitchClass[PitchClass["Gs"] = 8] = "Gs";
    PitchClass[PitchClass["A"] = 9] = "A";
    PitchClass[PitchClass["As"] = 10] = "As";
    PitchClass[PitchClass["B"] = 11] = "B";
})(PitchClass || (PitchClass = {}));
var Accidental;
(function (Accidental) {
    Accidental[Accidental["Natural"] = 0] = "Natural";
    Accidental[Accidental["Sharp"] = 1] = "Sharp";
    Accidental[Accidental["Flat"] = 2] = "Flat";
})(Accidental || (Accidental = {}));
var DurationType;
(function (DurationType) {
    DurationType[DurationType["Real"] = 0] = "Real";
    DurationType[DurationType["Sheet"] = 1] = "Sheet";
})(DurationType || (DurationType = {}));
class Pitch {
}
class Note {
}
class Notes {
    static latinName(p) {
        return Notes.latinNames[p];
    }
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.pitchClass;
    }
    static forNumber(n) {
        return { octave: n / 12 + 4, pitchClass: n % 12 };
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
    static toString(p) {
        return PitchClass[p.pitchClass].replace('s', '#') + p.octave;
    }
    static fromString(s) {
        var p = new Pitch();
        p.octave = parseInt(s.substring(s.length - 1));
        p.pitchClass = PitchClass[s.substring(0, s.length - 1).replace('#', 's')];
        return p;
    }
}
Notes.latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
class Kayboard {
    constructor(output) {
        this.keys = 'zsxdcvgbhnjmq2w3er5t6y7ui9o0p';
        this.id = 'keyboard';
        this.output = output;
        window.onkeydown = evt => output.start(this.forKey(evt.which));
        window.onkeyup = evt => output.stop(this.forKey(evt.which));
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="ext/webmidi.d.ts" />
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n, output) {
        return new MidiInput(id, this.inputs[n], output);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return { octave: Math.trunc(code / 12), pitchClass: code % 12 };
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.pitchClass;
    }
}
MidiUtils.enabled = false;
class MidiMessage {
}
class MidiInput {
    constructor(id, input, output) {
        this.id = id;
        this.input = input;
        this.output = output;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            console.log(evt.data, m, pitch, Notes.toString(pitch));
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                output.stop(pitch);
            }
            else if (m.type == 144) {
                output.start(pitch);
            }
        };
    }
}
class MidiOutput {
    constructor(id, output) {
        this.id = id;
        this.output = output;
    }
    start(pitch) {
        var m = { command: 9, channel: 0, type: 144, note: MidiUtils.fromPitch(pitch), velocity: 100 };
        console.log(m, pitch);
        this.output.send(MidiUtils.encode(m));
    }
    stop(pitch) {
        var m = { command: 9, channel: 0, type: 144, note: MidiUtils.fromPitch(pitch), velocity: 0 };
        this.output.send(MidiUtils.encode(m));
    }
}
class Oscillator {
    constructor(type) {
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
}
class PianoKeyboard {
    constructor(width, height, first, last) {
        this.id = 'pianoKeyboard';
        this.first = Notes.asNumber(first);
        this.keys = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(width / this.keys);
        this.canvas = document.createElement('canvas');
        this.canvas.width = width;
        this.canvas.height = height;
        this.canvas.style.border = '3px solid';
        this.ctx = this.canvas.getContext('2d');
        this.drawKeys();
        document.body.appendChild(this.canvas);
        this.canvas.onclick = evt => console.log(evt);
    }
    start(pitch) {
        this.drawPressed(pitch, 'red');
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = 'black';
        for (var key = 0; key < this.keys; key++) {
            var start = key * this.whiteKeyWidth;
            this.ctx.rect(start, 0, this.whiteKeyWidth, this.canvas.height);
            console.log(key, this.whiteKeyWidth, this.keys * this.whiteKeyWidth);
        }
        this.ctx.stroke();
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.first;
        let center = (n + 0.5) * this.whiteKeyWidth;
        this.ctx.beginPath();
        this.ctx.lineWidth = 0;
        this.ctx.arc(center, this.canvas.height * 0.8, this.whiteKeyWidth * 0.3, 0, 2 * Math.PI, false);
        this.ctx.fillStyle = color;
        this.ctx.fill();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L0Nob3J1cy50cyIsIi4uL3R5cGVzY3JpcHQvY29yZS9JbnB1dC50cyIsIi4uL3R5cGVzY3JpcHQvY29yZS9Ob3Rlcy50cyIsIi4uL3R5cGVzY3JpcHQvY29yZS9PdXRwdXQudHMiLCIuLi90eXBlc2NyaXB0L0tleWJvYXJkLnRzIiwiLi4vdHlwZXNjcmlwdC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L09zY2lsbGF0b3IudHMiLCIuLi90eXBlc2NyaXB0L1BpYW5vS2V5Ym9hcmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFO0lBQzFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFDeEIsSUFBSSxNQUFNLEdBQUcsSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMxRixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNoRSxDQUFDO1FBQ0QsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUMxQixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQ1RIO0lBS0ksWUFBWSxNQUFjLEVBQUUsS0FBYTtRQUNyQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN2QixDQUFDO0lBSUQsS0FBSyxDQUFDLEtBQVk7UUFDZCxVQUFVLENBQUM7WUFDUCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFBQSxDQUFDO0lBRUYsSUFBSSxDQUFDLEtBQVk7UUFDYixVQUFVLENBQUM7WUFDUCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QixDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFBQSxDQUFDO0NBR0w7QUV6QkQsSUFBSyxVQUVKO0FBRkQsV0FBSyxVQUFVO0lBQ1gscUNBQUMsQ0FBQTtJQUFFLHVDQUFFLENBQUE7SUFBRSxxQ0FBQyxDQUFBO0lBQUUsdUNBQUUsQ0FBQTtJQUFFLHFDQUFDLENBQUE7SUFBRSxxQ0FBQyxDQUFBO0lBQUUsdUNBQUUsQ0FBQTtJQUFFLHFDQUFDLENBQUE7SUFBRSx1Q0FBRSxDQUFBO0lBQUUscUNBQUMsQ0FBQTtJQUFFLHdDQUFFLENBQUE7SUFBRSxzQ0FBQyxDQUFBO0FBQzNDLENBQUMsRUFGSSxVQUFVLEtBQVYsVUFBVSxRQUVkO0FBRUQsSUFBSyxVQUVKO0FBRkQsV0FBSyxVQUFVO0lBQ1gsaURBQU8sQ0FBQTtJQUFFLDZDQUFLLENBQUE7SUFBRSwyQ0FBSSxDQUFBO0FBQ3hCLENBQUMsRUFGSSxVQUFVLEtBQVYsVUFBVSxRQUVkO0FBRUQsSUFBSyxZQUVKO0FBRkQsV0FBSyxZQUFZO0lBQ2IsK0NBQUksQ0FBQTtJQUFFLGlEQUFLLENBQUE7QUFDZixDQUFDLEVBRkksWUFBWSxLQUFaLFlBQVksUUFFaEI7QUFFRDtDQUdDO0FBRUQ7Q0FHQztBQUVEO0lBS0ksTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFhO1FBQzFCLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNLENBQUMsUUFBUSxDQUFDLENBQVE7UUFDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQztJQUM5QyxDQUFDO0lBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFTO1FBQ3RCLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFBO0lBQ3JELENBQUM7SUFFRCxNQUFNLENBQUMsU0FBUyxDQUFDLENBQVE7UUFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDNUQsQ0FBQztJQUVELE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBUTtRQUNwQixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDakUsQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBUztRQUN2QixJQUFJLENBQUMsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FB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O1FBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUUsSUFBSSxDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUMzQixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BCLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpIHtcbiAgICBNaWRpVXRpbHMuaW5pdGlhbGl6ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICB2YXIgb3V0cHV0ID0gbmV3IFBpYW5vS2V5Ym9hcmQoMTIzMiwgMTUwLCBOb3Rlcy5mcm9tU3RyaW5nKCdBMScpLCBOb3Rlcy5mcm9tU3RyaW5nKCdDOScpKTtcbiAgICAgICAgaWYgKE1pZGlVdGlscy5pbnB1dHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIGlucHV0ID0gTWlkaVV0aWxzLmNyZWF0ZUlucHV0KCdkZWZhdWx0TWlkaScsIDAsIG91dHB1dCk7XG4gICAgICAgIH1cbiAgICAgICAgd2luZG93WydvdXRwdXQnXSA9IG91dHB1dDtcbiAgICAgICAgd2luZG93WydwaWFubyddID0gTWlkaVV0aWxzLmNyZWF0ZU91dHB1dCgncGlhbm8nLCAwKTtcbiAgICB9KTtcbn0pOyIsImNsYXNzIENob3J1cyBpbXBsZW1lbnRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIG91dHB1dDogT3V0cHV0O1xuICAgIHByaXZhdGUgZGVsYXk6IG51bWJlcjtcblxuICAgIGNvbnN0cnVjdG9yKG91dHB1dDogT3V0cHV0LCBkZWxheTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0O1xuICAgICAgICB0aGlzLmRlbGF5ID0gZGVsYXk7XG4gICAgfVxuXG4gICAgaWQ6ICdjaG9ydXMnO1xuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQuc3RhcnQocGl0Y2gpO1xuICAgICAgICB9LCB0aGlzLmRlbGF5KTtcbiAgICB9O1xuXG4gICAgc3RvcChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dC5zdG9wKHBpdGNoKTtcbiAgICAgICAgfSwgdGhpcy5kZWxheSk7XG4gICAgfTtcblxuXG59IiwiaW50ZXJmYWNlIElucHV0IHtcblxuICAgIGlkOiBzdHJpbmc7XG59IiwiZW51bSBQaXRjaENsYXNzIHtcbiAgICBDLCBDcywgRCwgRHMsIEUsIEYsIEZzLCBHLCBHcywgQSwgQXMsIEJcbn1cblxuZW51bSBBY2NpZGVudGFsIHtcbiAgICBOYXR1cmFsLCBTaGFycCwgRmxhdFxufVxuXG5lbnVtIER1cmF0aW9uVHlwZSB7XG4gICAgUmVhbCwgU2hlZXRcbn1cblxuY2xhc3MgUGl0Y2gge1xuICAgIHBpdGNoQ2xhc3M6IFBpdGNoQ2xhc3M7XG4gICAgb2N0YXZlOiBudW1iZXI7XG59XG5cbmNsYXNzIE5vdGUge1xuICAgIHBpdGNoOiBQaXRjaDtcbiAgICBkdXJhdGlvbjogbnVtYmVyO1xufVxuXG5hYnN0cmFjdCBjbGFzcyBOb3RlcyB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBsYXRpbk5hbWVzID0gWydEbycsICdEbyMnLCAnUmUnLCAnUmUjJywgJ01pJywgJ0ZhJywgJ0ZhIycsICdTb2wnLCAnU29sIycsICdMYScsICdMYSMnLCAnU2knXTtcblxuXG4gICAgc3RhdGljIGxhdGluTmFtZShwOiBQaXRjaENsYXNzKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIE5vdGVzLmxhdGluTmFtZXNbcF07XG4gICAgfVxuXG4gICAgc3RhdGljIGFzTnVtYmVyKHA6IFBpdGNoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIChwLm9jdGF2ZSAtIDQpICogMTIgKyBwLnBpdGNoQ2xhc3M7XG4gICAgfVxuXG4gICAgc3RhdGljIGZvck51bWJlcihuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiB7IG9jdGF2ZTogbiAvIDEyICsgNCwgcGl0Y2hDbGFzczogbiAlIDEyIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgZnJlcXVlbmN5KHA6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBNYXRoLnBvdygyLCAoTm90ZXMuYXNOdW1iZXIocCkgLSA0OSkgLyAxMikgKiA0NDA7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvU3RyaW5nKHA6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBQaXRjaENsYXNzW3AucGl0Y2hDbGFzc10ucmVwbGFjZSgncycsICcjJykgKyBwLm9jdGF2ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZnJvbVN0cmluZyhzOiBzdHJpbmcpIHtcbiAgICAgICAgdmFyIHAgPSBuZXcgUGl0Y2goKTtcbiAgICAgICAgcC5vY3RhdmUgPSBwYXJzZUludChzLnN1YnN0cmluZyhzLmxlbmd0aCAtIDEpKTtcbiAgICAgICAgcC5waXRjaENsYXNzID0gUGl0Y2hDbGFzc1tzLnN1YnN0cmluZygwLCBzLmxlbmd0aCAtIDEpLnJlcGxhY2UoJyMnLCAncycpXTtcbiAgICAgICAgcmV0dXJuIHA7XG4gICAgfVxuXG59XG4iLCJpbnRlcmZhY2UgT3V0cHV0IHtcblxuICAgIGlkOiBzdHJpbmc7XG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoKTogdm9pZDtcbiAgICBzdG9wKHBpdGNoOiBQaXRjaCk6IHZvaWQ7XG5cbn0iLCJjbGFzcyBLYXlib2FyZCBpbXBsZW1lbnRzIElucHV0IHtcblxuICAgIHByaXZhdGUga2V5cyA9ICd6c3hkY3ZnYmhuam1xMnczZXI1dDZ5N3VpOW8wcCc7XG5cbiAgICBpZCA9ICdrZXlib2FyZCc7XG4gICAgcHJpdmF0ZSBvdXRwdXQ6IE91dHB1dDtcblxuICAgIGNvbnN0cnVjdG9yKG91dHB1dDogT3V0cHV0KSB7XG4gICAgICAgIHRoaXMub3V0cHV0ID0gb3V0cHV0O1xuICAgICAgICB3aW5kb3cub25rZXlkb3duID0gZXZ0ID0+IG91dHB1dC5zdGFydCh0aGlzLmZvcktleShldnQud2hpY2gpKTtcbiAgICAgICAgd2luZG93Lm9ua2V5dXAgPSBldnQgPT4gb3V0cHV0LnN0b3AodGhpcy5mb3JLZXkoZXZ0LndoaWNoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb3JLZXkobjogbnVtYmVyKTogUGl0Y2gge1xuICAgICAgICByZXR1cm4gTm90ZXMuZm9yTnVtYmVyKG4pO1xuICAgIH1cblxuXG5cbn0iLCIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiZXh0L3dlYm1pZGkuZC50c1wiIC8+XG5cbmNsYXNzIE1pZGlVdGlscyB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBlbmFibGVkOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBzdGF0aWMgaW5mbzogV2ViTWlkaS5NSURJQWNjZXNzO1xuICAgIHN0YXRpYyBvdXRwdXRzOiBBcnJheTxXZWJNaWRpLk1JRElPdXRwdXQ+O1xuICAgIHN0YXRpYyBpbnB1dHM6IEFycmF5PFdlYk1pZGkuTUlESUlucHV0PjtcblxuICAgIHN0YXRpYyBpbml0aWFsaXplKCkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBuYXZpZ2F0b3IucmVxdWVzdE1JRElBY2Nlc3MoKS50aGVuKFxuICAgICAgICAgICAgICAgICAgICB4ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5pbmZvID0geDtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5pbnB1dHMgPSBBcnJheS5mcm9tKHguaW5wdXRzLnZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5vdXRwdXRzID0gQXJyYXkuZnJvbSh4Lm91dHB1dHMudmFsdWVzKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgTWlkaVV0aWxzLmVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBNaWRpVXRpbHMuZW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHN0YXRpYyBkZWNvZGUoZGF0YTogVWludDhBcnJheSk6IE1pZGlNZXNzYWdlIHtcbiAgICAgICAgdmFyIG0gPSBuZXcgTWlkaU1lc3NhZ2UoKTtcbiAgICAgICAgbS5jb21tYW5kID0gZGF0YVswXSA+PiA0O1xuICAgICAgICBtLmNoYW5uZWwgPSBkYXRhWzBdICYgMHhmO1xuICAgICAgICBtLnR5cGUgPSBkYXRhWzBdICYgMHhmMDtcbiAgICAgICAgbS5ub3RlID0gZGF0YVsxXTtcbiAgICAgICAgbS52ZWxvY2l0eSA9IGRhdGFbMl07XG4gICAgICAgIHJldHVybiBtO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZW5jb2RlKG06IE1pZGlNZXNzYWdlKSB7XG4gICAgICAgIHZhciB4ID0gKG0uY2hhbm5lbCAmIDB4ZikgfCAobS50eXBlICYgMHhmMCkgfCAobS5jb21tYW5kIDw8IDQpO1xuICAgICAgICByZXR1cm4gW3gsIG0ubm90ZSwgbS52ZWxvY2l0eV07XG4gICAgfTtcblxuICAgIHN0YXRpYyBjcmVhdGVJbnB1dChpZDogc3RyaW5nLCBuOiBudW1iZXIsIG91dHB1dDogT3V0cHV0KSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaUlucHV0KGlkLCB0aGlzLmlucHV0c1tuXSwgb3V0cHV0KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgY3JlYXRlT3V0cHV0KGlkOiBzdHJpbmcsIG46IG51bWJlcikge1xuICAgICAgICByZXR1cm4gbmV3IE1pZGlPdXRwdXQoaWQsIHRoaXMub3V0cHV0c1tuXSk7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvUGl0Y2goY29kZTogbnVtYmVyKTogUGl0Y2gge1xuICAgICAgICByZXR1cm4geyBvY3RhdmU6IE1hdGgudHJ1bmMoY29kZSAvIDEyKSwgcGl0Y2hDbGFzczogY29kZSAlIDEyIH07XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21QaXRjaChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgcmV0dXJuIHBpdGNoLm9jdGF2ZSAqIDEyICsgcGl0Y2gucGl0Y2hDbGFzcztcbiAgICB9XG5cbn1cblxuY2xhc3MgTWlkaU1lc3NhZ2Uge1xuICAgIGNvbW1hbmQ6IG51bWJlcjtcbiAgICBjaGFubmVsOiBudW1iZXI7XG4gICAgdHlwZTogbnVtYmVyO1xuICAgIG5vdGU6IG51bWJlcjtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xufVxuXG5jbGFzcyBNaWRpSW5wdXQgaW1wbGVtZW50cyBJbnB1dCB7XG5cbiAgICByZWFkb25seSBpZDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgaW5wdXQ6IFdlYk1pZGkuTUlESUlucHV0LCBvdXRwdXQ6IE91dHB1dCkge1xuXG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICAgICAgdGhpcy5pbnB1dCA9IGlucHV0O1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcblxuICAgICAgICB0aGlzLmlucHV0Lm9ubWlkaW1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgdmFyIG0gPSBNaWRpVXRpbHMuZGVjb2RlKGV2dC5kYXRhKTtcbiAgICAgICAgICAgIHZhciBwaXRjaCA9IE1pZGlVdGlscy50b1BpdGNoKG0ubm90ZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldnQuZGF0YSwgbSwgcGl0Y2gsIE5vdGVzLnRvU3RyaW5nKHBpdGNoKSk7XG4gICAgICAgICAgICBpZiAobS50eXBlID09IDEyOCB8fCAobS50eXBlID09IDE0NCAmJiBtLnZlbG9jaXR5ID09IDApKSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnN0b3AocGl0Y2gpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChtLnR5cGUgPT0gMTQ0KSB7XG4gICAgICAgICAgICAgICAgb3V0cHV0LnN0YXJ0KHBpdGNoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgTWlkaU91dHB1dCBpbXBsZW1lbnRzIE91dHB1dCB7XG5cbiAgICByZWFkb25seSBpZDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogV2ViTWlkaS5NSURJT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQpIHtcbiAgICAgICAgdGhpcy5pZCA9IGlkO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdmFyIG06IE1pZGlNZXNzYWdlID0geyBjb21tYW5kOiA5LCBjaGFubmVsOiAwLCB0eXBlOiAxNDQsIG5vdGU6IE1pZGlVdGlscy5mcm9tUGl0Y2gocGl0Y2gpLCB2ZWxvY2l0eTogMTAwIH07XG4gICAgICAgIGNvbnNvbGUubG9nKG0sIHBpdGNoKTtcbiAgICAgICAgdGhpcy5vdXRwdXQuc2VuZChNaWRpVXRpbHMuZW5jb2RlKG0pKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB2YXIgbTogTWlkaU1lc3NhZ2UgPSB7IGNvbW1hbmQ6IDksIGNoYW5uZWw6IDAsIHR5cGU6IDE0NCwgbm90ZTogTWlkaVV0aWxzLmZyb21QaXRjaChwaXRjaCksIHZlbG9jaXR5OiAwIH07XG4gICAgICAgIHRoaXMub3V0cHV0LnNlbmQoTWlkaVV0aWxzLmVuY29kZShtKSk7XG4gICAgfVxuXG59IiwidHlwZSBXYXZlVHlwZSA9ICdzaW5lJyB8ICdzcXVhcmUnIHwgJ3Nhd3Rvb3RoJyB8ICd0cmlhbmdsZSc7XG5cblxuY2xhc3MgT3NjaWxsYXRvciBpbXBsZW1lbnRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG9zYzogT3NjaWxsYXRvck5vZGU7XG4gICAgaWQ6ICdvc2NpbGxhdG9yJztcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFdhdmVUeXBlKSB7XG4gICAgICAgIHZhciBjdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gICAgICAgIHRoaXMub3NjID0gY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTtcbiAgICAgICAgdGhpcy5vc2MudHlwZSA9IHR5cGU7XG4gICAgICAgIHRoaXMub3NjLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTtcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KHBpdGNoKTtcbiAgICAgICAgdGhpcy5vc2Muc3RhcnQoKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLm9zYy5zdG9wKCk7XG4gICAgfVxuXG59IiwiXG5jbGFzcyBQaWFub0tleWJvYXJkIGltcGxlbWVudHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlzOiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBmaXJzdDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgd2hpdGVLZXlXaWR0aDogbnVtYmVyO1xuXG4gICAgaWQgPSAncGlhbm9LZXlib2FyZCc7XG5cbiAgICBjb25zdHJ1Y3Rvcih3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZmlyc3Q6IFBpdGNoLCBsYXN0OiBQaXRjaCkge1xuXG4gICAgICAgIHRoaXMuZmlyc3QgPSBOb3Rlcy5hc051bWJlcihmaXJzdCk7XG4gICAgICAgIHRoaXMua2V5cyA9IE5vdGVzLmFzTnVtYmVyKGxhc3QpIC0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpICsgMTtcbiAgICAgICAgdGhpcy53aGl0ZUtleVdpZHRoID0gTWF0aC50cnVuYyh3aWR0aCAvIHRoaXMua2V5cyk7XG5cbiAgICAgICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB3aWR0aDtcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZS5ib3JkZXIgPSAnM3B4IHNvbGlkJztcbiAgICAgICAgdGhpcy5jdHggPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpICE7XG4gICAgICAgIHRoaXMuZHJhd0tleXMoKTtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNhbnZhcyk7XG5cbiAgICAgICAgdGhpcy5jYW52YXMub25jbGljayA9IGV2dCA9PiBjb25zb2xlLmxvZyhldnQpXG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHRoaXMuZHJhd1ByZXNzZWQocGl0Y2gsICdyZWQnKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLmRyYXdQcmVzc2VkKHBpdGNoLCAnd2hpdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRyYXdLZXlzKCkge1xuICAgICAgICB0aGlzLmN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgICAgIHRoaXMuY3R4LmxpbmVXaWR0aCA9IDI7XG4gICAgICAgIHRoaXMuY3R4LnN0cm9rZVN0eWxlID0gJ2JsYWNrJztcbiAgICAgICAgZm9yICh2YXIga2V5ID0gMDsga2V5IDwgdGhpcy5rZXlzOyBrZXkrKykge1xuICAgICAgICAgICAgdmFyIHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoO1xuICAgICAgICAgICAgdGhpcy5jdHgucmVjdChzdGFydCwgMCwgdGhpcy53aGl0ZUtleVdpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCB0aGlzLndoaXRlS2V5V2lkdGgsIHRoaXMua2V5cyAqIHRoaXMud2hpdGVLZXlXaWR0aCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jdHguc3Ryb2tlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3UHJlc3NlZChwOiBQaXRjaCwgY29sb3I6IHN0cmluZykge1xuICAgICAgICBsZXQgbiA9IE5vdGVzLmFzTnVtYmVyKHApIC0gdGhpcy5maXJzdDtcbiAgICAgICAgbGV0IGNlbnRlciA9IChuICsgMC41KSAqIHRoaXMud2hpdGVLZXlXaWR0aDtcbiAgICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIHRoaXMuY3R4LmxpbmVXaWR0aCA9IDA7XG4gICAgICAgIHRoaXMuY3R4LmFyYyhjZW50ZXIsIHRoaXMuY2FudmFzLmhlaWdodCAqIDAuOCwgdGhpcy53aGl0ZUtleVdpZHRoICogMC4zLCAwLCAyICogTWF0aC5QSSwgZmFsc2UpO1xuICAgICAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSBjb2xvcjtcbiAgICAgICAgdGhpcy5jdHguZmlsbCgpO1xuICAgIH1cblxufSJdfQ==