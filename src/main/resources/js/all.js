document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        let connector = new Connector();
        var output = new PianoKeyboard(1232, 300, Notes.fromString('A1'), Notes.fromString('C9'));
        connector.addOutput(output);
        if (MidiUtils.inputs.length > 0) {
            var input = MidiUtils.createInput('defaultMidi', 0);
            connector.addInput(input);
        }
        window['output'] = output;
        window['piano'] = MidiUtils.createOutput('piano', 0);
    });
});
class Input {
    constructor(id) {
        this.id = id;
    }
    start(p, velocity) {
        if (this.onStart != null) {
            this.onStart(p, velocity);
        }
    }
    stop(p) {
        if (this.onStop != null) {
            this.onStop(p);
        }
    }
}
class Notes {
    static latinName(p) {
        return Notes.latinNames[p];
    }
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.pitchClass;
    }
    static forNumber(n) {
        return { octave: n / 12 + 4, pitchClass: n % 12 };
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
    static toString(p) {
        return PitchClass[p.pitchClass].replace('s', '#') + p.octave;
    }
    static fromString(s) {
        var p = new Pitch();
        p.octave = parseInt(s.substring(s.length - 1));
        p.pitchClass = PitchClass[s.substring(0, s.length - 1).replace('#', 's')];
        return p;
    }
}
Notes.defaultVelocity = 0.7;
Notes.latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
class Output {
    constructor(id) {
        this.id = id;
    }
}
var PitchClass;
(function (PitchClass) {
    PitchClass[PitchClass["C"] = 0] = "C";
    PitchClass[PitchClass["Cs"] = 1] = "Cs";
    PitchClass[PitchClass["D"] = 2] = "D";
    PitchClass[PitchClass["Ds"] = 3] = "Ds";
    PitchClass[PitchClass["E"] = 4] = "E";
    PitchClass[PitchClass["F"] = 5] = "F";
    PitchClass[PitchClass["Fs"] = 6] = "Fs";
    PitchClass[PitchClass["G"] = 7] = "G";
    PitchClass[PitchClass["Gs"] = 8] = "Gs";
    PitchClass[PitchClass["A"] = 9] = "A";
    PitchClass[PitchClass["As"] = 10] = "As";
    PitchClass[PitchClass["B"] = 11] = "B";
})(PitchClass || (PitchClass = {}));
var Accidental;
(function (Accidental) {
    Accidental[Accidental["Natural"] = 0] = "Natural";
    Accidental[Accidental["Sharp"] = 1] = "Sharp";
    Accidental[Accidental["Flat"] = 2] = "Flat";
})(Accidental || (Accidental = {}));
var DurationType;
(function (DurationType) {
    DurationType[DurationType["Real"] = 0] = "Real";
    DurationType[DurationType["Sheet"] = 1] = "Sheet";
})(DurationType || (DurationType = {}));
class Pitch {
}
class Note {
}
class Connector {
    constructor() {
        this.inputs = [];
        this.outputs = [];
    }
    addInput(i) {
        this.inputs.push(i);
        i.onStart = (p, velocity) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.start(p, velocity);
                }
            });
        };
        i.onStop = (p) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.stop(p);
                }
            });
        };
    }
    addOutput(o) {
        this.outputs.push(o);
    }
}
class Keyboard extends Input {
    constructor() {
        super('keyboard');
        this.keys = 'zsxdcvgbhnjmq2w3er5t6y7ui9o0p';
        window.onkeydown = evt => this.start(this.forKey(evt.which), Notes.defaultVelocity);
        window.onkeyup = evt => this.stop(this.forKey(evt.which));
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="../ext/webmidi.d.ts" />
class MidiMessage {
}
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n) {
        return new MidiInput(id, this.inputs[n]);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return { octave: Math.trunc(code / 12), pitchClass: code % 12 };
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.pitchClass;
    }
}
MidiUtils.enabled = false;
class MidiInput extends Input {
    constructor(id, input) {
        super(id);
        this.input = input;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            console.log(evt.data, m, pitch, Notes.toString(pitch));
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                this.stop(pitch);
            }
            else if (m.type == 144) {
                this.start(pitch, m.velocity / 127);
            }
        };
    }
}
class MidiOutput extends Output {
    constructor(id, output) {
        super(id);
        this.output = output;
    }
    start(p, velocity) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: Math.trunc(velocity * 127) // 
        }));
    }
    stop(p) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: 0
        }));
    }
}
class Oscillator extends Output {
    constructor(type) {
        super('oscillator');
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch, velocity) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
}
class OutputChorus extends Output {
    constructor(id, output, delay, decay, times) {
        super(id);
        this.output = output;
        this.delay = delay;
        this.decay = decay;
        this.times = times;
    }
    start(pitch, velocity) {
        for (var i = 0; i < this.times; i++) {
            velocity *= this.decay;
            setTimeout(() => this.output.start(pitch, velocity, this.delay * (i + 1)));
        }
    }
    stop(pitch) {
        setTimeout(() => this.output.stop(pitch), this.delay * (this.times + 1));
    }
}
class PianoKeyboardCanvas extends Output {
    constructor(width, height, first, last) {
        super('pianoKeyboard');
        this.first = Notes.asNumber(first);
        this.keys = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(width / this.keys);
        this.canvas = document.createElement('canvas');
        this.canvas.width = width;
        this.canvas.height = height;
        this.canvas.style.border = '3px solid';
        this.ctx = this.canvas.getContext('2d');
        this.drawKeys();
        document.body.appendChild(this.canvas);
        this.canvas.onclick = evt => console.log(evt);
    }
    start(pitch) {
        this.drawPressed(pitch, 'red');
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = 'black';
        for (var key = 0; key < this.keys; key++) {
            var start = key * this.whiteKeyWidth;
            this.ctx.rect(start, 0, this.whiteKeyWidth, this.canvas.height);
            console.log(key, this.whiteKeyWidth, this.keys * this.whiteKeyWidth);
        }
        this.ctx.stroke();
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.first;
        let center = (n + 0.5) * this.whiteKeyWidth;
        this.ctx.beginPath();
        this.ctx.lineWidth = 0;
        this.ctx.arc(center, this.canvas.height * 0.8, this.whiteKeyWidth * 0.3, 0, 2 * Math.PI, false);
        this.ctx.fillStyle = color;
        this.ctx.fill();
    }
}
class PianoKeyboard extends Output {
    constructor(width, height, first, last) {
        super('pianoKeyboard');
        this.keysPainted = [];
        this.first = Notes.asNumber(first);
        this.keys = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(width / this.keys);
        this.canvas = Snap(width, height);
        //        this.canvas.rect(10, 10, 100, 100);
        this.drawKeys();
    }
    start(pitch) {
        this.drawPressed(pitch, 'red');
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        var attrs = { fill: '#fff', stroke: '#000', strokeWidth: 1 };
        for (let key = 0; key < this.keys; key++) {
            let start = key * this.whiteKeyWidth;
            console.log(this.canvas.getBBox());
            let rect = this.canvas.rect(start, 0, this.whiteKeyWidth, this.canvas.getBBox().height);
            rect.attr(attrs);
            this.keysPainted.push(rect);
            rect.data('key', key);
            rect.click((event) => {
                console.log(key, event);
            });
        }
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.first;
        let key = this.keysPainted[n];
        key.attr({ fill: color });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvaW5wdXQudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvbWVzc2FnZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvbm90ZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvb3V0cHV0LnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL3R5cGVzLnRzIiwiLi4vdHlwZXNjcmlwdC9pbXBsL0Nvbm5lY3Rvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvT3NjaWxsYXRvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9PdXRwdXRDaG9ydXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC1jYW52YXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7SUFDMUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQztRQUV4QixJQUFJLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBSWhDLElBQUksTUFBTSxHQUFHLElBQUksYUFBYSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDMUYsU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUc1QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksS0FBSyxHQUFHLFNB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QztRQUN2QyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5QixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gICAgTWlkaVV0aWxzLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcblxuICAgICAgICBsZXQgY29ubmVjdG9yID0gbmV3IENvbm5lY3RvcigpO1xuXG5cblxuICAgICAgICB2YXIgb3V0cHV0ID0gbmV3IFBpYW5vS2V5Ym9hcmQoMTIzMiwgMzAwLCBOb3Rlcy5mcm9tU3RyaW5nKCdBMScpLCBOb3Rlcy5mcm9tU3RyaW5nKCdDOScpKTtcbiAgICAgICAgY29ubmVjdG9yLmFkZE91dHB1dChvdXRwdXQpO1xuXG5cbiAgICAgICAgaWYgKE1pZGlVdGlscy5pbnB1dHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdmFyIGlucHV0ID0gTWlkaVV0aWxzLmNyZWF0ZUlucHV0KCdkZWZhdWx0TWlkaScsIDApO1xuICAgICAgICAgICAgY29ubmVjdG9yLmFkZElucHV0KGlucHV0KTtcbiAgICAgICAgfVxuICAgICAgICB3aW5kb3dbJ291dHB1dCddID0gb3V0cHV0O1xuICAgICAgICB3aW5kb3dbJ3BpYW5vJ10gPSBNaWRpVXRpbHMuY3JlYXRlT3V0cHV0KCdwaWFubycsIDApO1xuICAgIH0pO1xufSk7IiwiYWJzdHJhY3QgY2xhc3MgSW5wdXQge1xuXG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcbiAgICBvblN0YXJ0OiAoKHA6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKSA9PiBhbnkpIHwgbnVsbDtcbiAgICBvblN0b3A6ICgocDogUGl0Y2gpID0+IGFueSkgfCBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHN0YXJ0KHA6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKSB7XG4gICAgICAgIGlmICh0aGlzLm9uU3RhcnQgIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5vblN0YXJ0KHAsIHZlbG9jaXR5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByb3RlY3RlZCBzdG9wKHA6IFBpdGNoKSB7XG4gICAgICAgIGlmICh0aGlzLm9uU3RvcCAhPSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLm9uU3RvcChwKTtcbiAgICAgICAgfVxuICAgIH1cblxufSIsIiIsImFic3RyYWN0IGNsYXNzIE5vdGVzIHtcblxuICAgIHN0YXRpYyByZWFkb25seSBkZWZhdWx0VmVsb2NpdHkgPSAwLjc7XG5cbiAgICBwcml2YXRlIHN0YXRpYyBsYXRpbk5hbWVzID0gWydEbycsICdEbyMnLCAnUmUnLCAnUmUjJywgJ01pJywgJ0ZhJywgJ0ZhIycsICdTb2wnLCAnU29sIycsICdMYScsICdMYSMnLCAnU2knXTtcblxuXG4gICAgc3RhdGljIGxhdGluTmFtZShwOiBQaXRjaENsYXNzKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIE5vdGVzLmxhdGluTmFtZXNbcF07XG4gICAgfVxuXG4gICAgc3RhdGljIGFzTnVtYmVyKHA6IFBpdGNoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIChwLm9jdGF2ZSAtIDQpICogMTIgKyBwLnBpdGNoQ2xhc3M7XG4gICAgfVxuXG4gICAgc3RhdGljIGZvck51bWJlcihuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiB7IG9jdGF2ZTogbiAvIDEyICsgNCwgcGl0Y2hDbGFzczogbiAlIDEyIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgZnJlcXVlbmN5KHA6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBNYXRoLnBvdygyLCAoTm90ZXMuYXNOdW1iZXIocCkgLSA0OSkgLyAxMikgKiA0NDA7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvU3RyaW5nKHA6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBQaXRjaENsYXNzW3AucGl0Y2hDbGFzc10ucmVwbGFjZSgncycsICcjJykgKyBwLm9jdGF2ZTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZnJvbVN0cmluZyhzOiBzdHJpbmcpIHtcbiAgICAgICAgdmFyIHAgPSBuZXcgUGl0Y2goKTtcbiAgICAgICAgcC5vY3RhdmUgPSBwYXJzZUludChzLnN1YnN0cmluZyhzLmxlbmd0aCAtIDEpKTtcbiAgICAgICAgcC5waXRjaENsYXNzID0gUGl0Y2hDbGFzc1tzLnN1YnN0cmluZygwLCBzLmxlbmd0aCAtIDEpLnJlcGxhY2UoJyMnLCAncycpXTtcbiAgICAgICAgcmV0dXJuIHA7XG4gICAgfVxuXG59XG4iLCJhYnN0cmFjdCBjbGFzcyBPdXRwdXQge1xuXG4gICAgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGlkKSB7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICB9XG5cbiAgICBhYnN0cmFjdCBzdGFydChwOiBQaXRjaCwgdmVsb2NpdHk6IG51bWJlcik6IHZvaWQ7XG4gICAgYWJzdHJhY3Qgc3RvcChwOiBQaXRjaCk6IHZvaWQ7XG5cbn0iLCJlbnVtIFBpdGNoQ2xhc3Mge1xuICAgIEMsIENzLCBELCBEcywgRSwgRiwgRnMsIEcsIEdzLCBBLCBBcywgQlxufVxuXG5lbnVtIEFjY2lkZW50YWwge1xuICAgIE5hdHVyYWwsIFNoYXJwLCBGbGF0XG59XG5cbmVudW0gRHVyYXRpb25UeXBlIHtcbiAgICBSZWFsLCBTaGVldFxufVxuXG5jbGFzcyBQaXRjaCB7XG4gICAgcGl0Y2hDbGFzczogUGl0Y2hDbGFzcztcbiAgICBvY3RhdmU6IG51bWJlcjtcbn1cblxuY2xhc3MgTm90ZSB7XG4gICAgcGl0Y2g6IFBpdGNoO1xuICAgIHZlbG9jaXR5OiBudW1iZXI7XG4gICAgZHVyYXRpb246IG51bWJlciB8IG51bGw7XG59XG5cbiIsImNsYXNzIENvbm5lY3RvciB7XG5cbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5wdXRzOiBJbnB1dFtdID0gW107XG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IG91dHB1dHM6IE91dHB1dFtdID0gW107XG5cblxuICAgIGFkZElucHV0KGk6IElucHV0KSB7XG4gICAgICAgIHRoaXMuaW5wdXRzLnB1c2goaSk7XG4gICAgICAgIGkub25TdGFydCA9IChwOiBQaXRjaCwgdmVsb2NpdHk6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXRzLmZvckVhY2gobyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG8uaWQgIT0gaS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBvLnN0YXJ0KHAsIHZlbG9jaXR5KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGkub25TdG9wID0gKHA6IFBpdGNoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm91dHB1dHMuZm9yRWFjaChvID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoby5pZCAhPSBpLmlkKSB7XG4gICAgICAgICAgICAgICAgICAgIG8uc3RvcChwKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYWRkT3V0cHV0KG86IE91dHB1dCkge1xuICAgICAgICB0aGlzLm91dHB1dHMucHVzaChvKTtcbiAgICB9XG5cbn0iLCJjbGFzcyBLZXlib2FyZCBleHRlbmRzIElucHV0IHtcblxuICAgIHByaXZhdGUga2V5cyA9ICd6c3hkY3ZnYmhuam1xMnczZXI1dDZ5N3VpOW8wcCc7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoJ2tleWJvYXJkJyk7XG4gICAgICAgIHdpbmRvdy5vbmtleWRvd24gPSBldnQgPT4gdGhpcy5zdGFydCh0aGlzLmZvcktleShldnQud2hpY2gpLCBOb3Rlcy5kZWZhdWx0VmVsb2NpdHkpO1xuICAgICAgICB3aW5kb3cub25rZXl1cCA9IGV2dCA9PiB0aGlzLnN0b3AodGhpcy5mb3JLZXkoZXZ0LndoaWNoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb3JLZXkobjogbnVtYmVyKTogUGl0Y2gge1xuICAgICAgICByZXR1cm4gTm90ZXMuZm9yTnVtYmVyKG4pO1xuICAgIH1cblxufSAiLCIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vZXh0L3dlYm1pZGkuZC50c1wiIC8+XG5cbmNsYXNzIE1pZGlNZXNzYWdlIHtcbiAgICBjb21tYW5kOiBudW1iZXI7XG4gICAgY2hhbm5lbDogbnVtYmVyO1xuICAgIHR5cGU6IG51bWJlcjtcbiAgICBub3RlOiBudW1iZXI7XG4gICAgdmVsb2NpdHk6IG51bWJlcjtcbn1cblxuY2xhc3MgTWlkaVV0aWxzIHtcblxuICAgIHByaXZhdGUgc3RhdGljIGVuYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBwcml2YXRlIHN0YXRpYyBpbmZvOiBXZWJNaWRpLk1JRElBY2Nlc3M7XG4gICAgc3RhdGljIG91dHB1dHM6IEFycmF5PFdlYk1pZGkuTUlESU91dHB1dD47XG4gICAgc3RhdGljIGlucHV0czogQXJyYXk8V2ViTWlkaS5NSURJSW5wdXQ+O1xuXG4gICAgc3RhdGljIGluaXRpYWxpemUoKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG5hdmlnYXRvci5yZXF1ZXN0TUlESUFjY2VzcygpLnRoZW4oXG4gICAgICAgICAgICAgICAgICAgIHggPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgTWlkaVV0aWxzLmluZm8gPSB4O1xuICAgICAgICAgICAgICAgICAgICAgICAgTWlkaVV0aWxzLmlucHV0cyA9IEFycmF5LmZyb20oeC5pbnB1dHMudmFsdWVzKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgTWlkaVV0aWxzLm91dHB1dHMgPSBBcnJheS5mcm9tKHgub3V0cHV0cy52YWx1ZXMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuZW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIE1pZGlVdGlscy5lbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGRlY29kZShkYXRhOiBVaW50OEFycmF5KTogTWlkaU1lc3NhZ2Uge1xuICAgICAgICB2YXIgbSA9IG5ldyBNaWRpTWVzc2FnZSgpO1xuICAgICAgICBtLmNvbW1hbmQgPSBkYXRhWzBdID4+IDQ7XG4gICAgICAgIG0uY2hhbm5lbCA9IGRhdGFbMF0gJiAweGY7XG4gICAgICAgIG0udHlwZSA9IGRhdGFbMF0gJiAweGYwO1xuICAgICAgICBtLm5vdGUgPSBkYXRhWzFdO1xuICAgICAgICBtLnZlbG9jaXR5ID0gZGF0YVsyXTtcbiAgICAgICAgcmV0dXJuIG07XG4gICAgfTtcblxuICAgIHN0YXRpYyBlbmNvZGUobTogTWlkaU1lc3NhZ2UpIHtcbiAgICAgICAgdmFyIHggPSAobS5jaGFubmVsICYgMHhmKSB8IChtLnR5cGUgJiAweGYwKSB8IChtLmNvbW1hbmQgPDwgNCk7XG4gICAgICAgIHJldHVybiBbeCwgbS5ub3RlLCBtLnZlbG9jaXR5XTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGNyZWF0ZUlucHV0KGlkOiBzdHJpbmcsIG46IG51bWJlcikge1xuICAgICAgICByZXR1cm4gbmV3IE1pZGlJbnB1dChpZCwgdGhpcy5pbnB1dHNbbl0pO1xuICAgIH1cblxuICAgIHN0YXRpYyBjcmVhdGVPdXRwdXQoaWQ6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaU91dHB1dChpZCwgdGhpcy5vdXRwdXRzW25dKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgdG9QaXRjaChjb2RlOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiB7IG9jdGF2ZTogTWF0aC50cnVuYyhjb2RlIC8gMTIpLCBwaXRjaENsYXNzOiBjb2RlICUgMTIgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZnJvbVBpdGNoKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICByZXR1cm4gcGl0Y2gub2N0YXZlICogMTIgKyBwaXRjaC5waXRjaENsYXNzO1xuICAgIH1cblxufVxuXG5cblxuY2xhc3MgTWlkaUlucHV0IGV4dGVuZHMgSW5wdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbnB1dDogV2ViTWlkaS5NSURJSW5wdXQ7XG5cbiAgICBjb25zdHJ1Y3RvcihpZDogc3RyaW5nLCBpbnB1dDogV2ViTWlkaS5NSURJSW5wdXQpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLmlucHV0ID0gaW5wdXQ7XG5cbiAgICAgICAgdGhpcy5pbnB1dC5vbm1pZGltZXNzYWdlID0gZXZ0ID0+IHtcbiAgICAgICAgICAgIHZhciBtID0gTWlkaVV0aWxzLmRlY29kZShldnQuZGF0YSk7XG4gICAgICAgICAgICB2YXIgcGl0Y2ggPSBNaWRpVXRpbHMudG9QaXRjaChtLm5vdGUpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXZ0LmRhdGEsIG0sIHBpdGNoLCBOb3Rlcy50b1N0cmluZyhwaXRjaCkpO1xuICAgICAgICAgICAgaWYgKG0udHlwZSA9PSAxMjggfHwgKG0udHlwZSA9PSAxNDQgJiYgbS52ZWxvY2l0eSA9PSAwKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcChwaXRjaCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG0udHlwZSA9PSAxNDQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0KHBpdGNoLCBtLnZlbG9jaXR5IC8gMTI3KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgTWlkaU91dHB1dCBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogV2ViTWlkaS5NSURJT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICB9XG5cbiAgICBzdGFydChwOiBQaXRjaCwgdmVsb2NpdHk6IG51bWJlcikge1xuICAgICAgICB0aGlzLm91dHB1dC5zZW5kKE1pZGlVdGlscy5lbmNvZGUoeyAvL1xuICAgICAgICAgICAgY29tbWFuZDogOSwgLy9cbiAgICAgICAgICAgIGNoYW5uZWw6IDAsIC8vXG4gICAgICAgICAgICB0eXBlOiAxNDQsIC8vXG4gICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKHApLCAvLyBcbiAgICAgICAgICAgIHZlbG9jaXR5OiBNYXRoLnRydW5jKHZlbG9jaXR5ICogMTI3KSAvLyBcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHN0b3AocDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5vdXRwdXQuc2VuZChNaWRpVXRpbHMuZW5jb2RlKHsgLy9cbiAgICAgICAgICAgIGNvbW1hbmQ6IDksIC8vXG4gICAgICAgICAgICBjaGFubmVsOiAwLCAvL1xuICAgICAgICAgICAgdHlwZTogMTQ0LCAvL1xuICAgICAgICAgICAgbm90ZTogTWlkaVV0aWxzLmZyb21QaXRjaChwKSwgLy8gXG4gICAgICAgICAgICB2ZWxvY2l0eTogMFxuICAgICAgICB9KSk7XG4gICAgfVxuXG59IiwidHlwZSBXYXZlVHlwZSA9ICdzaW5lJyB8ICdzcXVhcmUnIHwgJ3Nhd3Rvb3RoJyB8ICd0cmlhbmdsZSc7XG5cbmNsYXNzIE9zY2lsbGF0b3IgZXh0ZW5kcyBPdXRwdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBvc2M6IE9zY2lsbGF0b3JOb2RlO1xuXG4gICAgY29uc3RydWN0b3IodHlwZTogV2F2ZVR5cGUpIHtcbiAgICAgICAgc3VwZXIoJ29zY2lsbGF0b3InKTtcbiAgICAgICAgdmFyIGN0eCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgICAgICAgdGhpcy5vc2MgPSBjdHguY3JlYXRlT3NjaWxsYXRvcigpO1xuICAgICAgICB0aGlzLm9zYy50eXBlID0gdHlwZTtcbiAgICAgICAgdGhpcy5vc2MuY29ubmVjdChjdHguZGVzdGluYXRpb24pO1xuICAgIH1cblxuICAgIHN0YXJ0KHBpdGNoOiBQaXRjaCwgdmVsb2NpdHk6bnVtYmVyKSB7XG4gICAgICAgIHRoaXMub3NjLmZyZXF1ZW5jeS52YWx1ZSA9IE5vdGVzLmZyZXF1ZW5jeShwaXRjaCk7XG4gICAgICAgIHRoaXMub3NjLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgc3RvcChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5vc2Muc3RvcCgpO1xuICAgIH1cblxufSIsImNsYXNzIE91dHB1dENob3J1cyBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogYW55O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVsYXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlY2F5OiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSB0aW1lczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoaWQsIG91dHB1dDogT3V0cHV0LCBkZWxheTogbnVtYmVyLCBkZWNheTogbnVtYmVyLCB0aW1lczogbnVtYmVyKSB7XG4gICAgICAgIHN1cGVyKGlkKTtcbiAgICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXQ7XG4gICAgICAgIHRoaXMuZGVsYXkgPSBkZWxheTtcbiAgICAgICAgdGhpcy5kZWNheSA9IGRlY2F5O1xuICAgICAgICB0aGlzLnRpbWVzID0gdGltZXM7XG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoLCB2ZWxvY2l0eSkge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGltZXM7IGkrKykge1xuICAgICAgICAgICAgdmVsb2NpdHkgKj0gdGhpcy5kZWNheTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RhcnQocGl0Y2gsIHZlbG9jaXR5LCB0aGlzLmRlbGF5ICogKGkgKyAxKSkpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMub3V0cHV0LnN0b3AocGl0Y2gpLCB0aGlzLmRlbGF5ICogKHRoaXMudGltZXMgKyAxKSk7XG4gICAgfVxuXG59IiwiXG5jbGFzcyBQaWFub0tleWJvYXJkQ2FudmFzIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlzOiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBmaXJzdDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgd2hpdGVLZXlXaWR0aDogbnVtYmVyO1xuXG5cbiAgICBjb25zdHJ1Y3Rvcih3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZmlyc3Q6IFBpdGNoLCBsYXN0OiBQaXRjaCkge1xuICAgICAgICBzdXBlcigncGlhbm9LZXlib2FyZCcpO1xuICAgICAgICB0aGlzLmZpcnN0ID0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpO1xuICAgICAgICB0aGlzLmtleXMgPSBOb3Rlcy5hc051bWJlcihsYXN0KSAtIE5vdGVzLmFzTnVtYmVyKGZpcnN0KSArIDE7XG4gICAgICAgIHRoaXMud2hpdGVLZXlXaWR0aCA9IE1hdGgudHJ1bmMod2lkdGggLyB0aGlzLmtleXMpO1xuXG4gICAgICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XG4gICAgICAgIHRoaXMuY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgdGhpcy5jYW52YXMuc3R5bGUuYm9yZGVyID0gJzNweCBzb2xpZCc7XG4gICAgICAgIHRoaXMuY3R4ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKSAhO1xuICAgICAgICB0aGlzLmRyYXdLZXlzKCk7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5jYW52YXMpO1xuXG4gICAgICAgIHRoaXMuY2FudmFzLm9uY2xpY2sgPSBldnQgPT4gY29uc29sZS5sb2coZXZ0KVxuICAgIH1cblxuICAgIHN0YXJ0KHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLmRyYXdQcmVzc2VkKHBpdGNoLCAncmVkJyk7XG4gICAgfVxuXG4gICAgc3RvcChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5kcmF3UHJlc3NlZChwaXRjaCwgJ3doaXRlJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3S2V5cygpIHtcbiAgICAgICAgdGhpcy5jdHguY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICB0aGlzLmN0eC5saW5lV2lkdGggPSAyO1xuICAgICAgICB0aGlzLmN0eC5zdHJva2VTdHlsZSA9ICdibGFjayc7XG4gICAgICAgIGZvciAodmFyIGtleSA9IDA7IGtleSA8IHRoaXMua2V5czsga2V5KyspIHtcbiAgICAgICAgICAgIHZhciBzdGFydCA9IGtleSAqIHRoaXMud2hpdGVLZXlXaWR0aDtcbiAgICAgICAgICAgIHRoaXMuY3R4LnJlY3Qoc3RhcnQsIDAsIHRoaXMud2hpdGVLZXlXaWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGtleSwgdGhpcy53aGl0ZUtleVdpZHRoLCB0aGlzLmtleXMgKiB0aGlzLndoaXRlS2V5V2lkdGgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY3R4LnN0cm9rZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhd1ByZXNzZWQocDogUGl0Y2gsIGNvbG9yOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IG4gPSBOb3Rlcy5hc051bWJlcihwKSAtIHRoaXMuZmlyc3Q7XG4gICAgICAgIGxldCBjZW50ZXIgPSAobiArIDAuNSkgKiB0aGlzLndoaXRlS2V5V2lkdGg7XG4gICAgICAgIHRoaXMuY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgICB0aGlzLmN0eC5saW5lV2lkdGggPSAwO1xuICAgICAgICB0aGlzLmN0eC5hcmMoY2VudGVyLCB0aGlzLmNhbnZhcy5oZWlnaHQgKiAwLjgsIHRoaXMud2hpdGVLZXlXaWR0aCAqIDAuMywgMCwgMiAqIE1hdGguUEksIGZhbHNlKTtcbiAgICAgICAgdGhpcy5jdHguZmlsbFN0eWxlID0gY29sb3I7XG4gICAgICAgIHRoaXMuY3R4LmZpbGwoKTtcbiAgICB9XG5cbn0iLCJcbmNsYXNzIFBpYW5vS2V5Ym9hcmQgZXh0ZW5kcyBPdXRwdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYW52YXM6IFNuYXAuUGFwZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkga2V5czogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZmlyc3Q6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHdoaXRlS2V5V2lkdGg6IG51bWJlcjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkga2V5c1BhaW50ZWQ6IEFycmF5PFNuYXAuRWxlbWVudD4gPSBbXTtcblxuXG5cbiAgICBjb25zdHJ1Y3Rvcih3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZmlyc3Q6IFBpdGNoLCBsYXN0OiBQaXRjaCkge1xuICAgICAgICBzdXBlcigncGlhbm9LZXlib2FyZCcpO1xuXG4gICAgICAgIHRoaXMuZmlyc3QgPSBOb3Rlcy5hc051bWJlcihmaXJzdCk7XG4gICAgICAgIHRoaXMua2V5cyA9IE5vdGVzLmFzTnVtYmVyKGxhc3QpIC0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpICsgMTtcbiAgICAgICAgdGhpcy53aGl0ZUtleVdpZHRoID0gTWF0aC50cnVuYyh3aWR0aCAvIHRoaXMua2V5cyk7XG5cblxuICAgICAgICB0aGlzLmNhbnZhcyA9IFNuYXAod2lkdGgsIGhlaWdodCk7XG4gICAgICAgIC8vICAgICAgICB0aGlzLmNhbnZhcy5yZWN0KDEwLCAxMCwgMTAwLCAxMDApO1xuXG4gICAgICAgIHRoaXMuZHJhd0tleXMoKTtcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5kcmF3UHJlc3NlZChwaXRjaCwgJ3JlZCcpO1xuICAgIH1cblxuICAgIHN0b3AocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHRoaXMuZHJhd1ByZXNzZWQocGl0Y2gsICd3aGl0ZScpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZHJhd0tleXMoKSB7XG4gICAgICAgIHZhciBhdHRycyA9IHsgZmlsbDogJyNmZmYnLCBzdHJva2U6ICcjMDAwJywgc3Ryb2tlV2lkdGg6IDEgfTtcbiAgICAgICAgZm9yIChsZXQga2V5ID0gMDsga2V5IDwgdGhpcy5rZXlzOyBrZXkrKykge1xuICAgICAgICAgICAgbGV0IHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoO1xuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5jYW52YXMuZ2V0QkJveCgpKTtcbiAgICAgICAgICAgIGxldCByZWN0ID0gdGhpcy5jYW52YXMucmVjdChzdGFydCwgMCwgdGhpcy53aGl0ZUtleVdpZHRoLCB0aGlzLmNhbnZhcy5nZXRCQm94KCkuaGVpZ2h0KTtcbiAgICAgICAgICAgIHJlY3QuYXR0cihhdHRycyk7XG4gICAgICAgICAgICB0aGlzLmtleXNQYWludGVkLnB1c2gocmVjdCk7XG4gICAgICAgICAgICByZWN0LmRhdGEoJ2tleScsIGtleSk7XG5cbiAgICAgICAgICAgIHJlY3QuY2xpY2soKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCBldmVudCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZHJhd1ByZXNzZWQocDogUGl0Y2gsIGNvbG9yOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IG4gPSBOb3Rlcy5hc051bWJlcihwKSAtIHRoaXMuZmlyc3Q7XG4gICAgICAgIGxldCBrZXkgPSB0aGlzLmtleXNQYWludGVkW25dO1xuICAgICAgICBrZXkuYXR0cih7IGZpbGw6IGNvbG9yIH0pO1xuICAgIH1cblxufSJdfQ==