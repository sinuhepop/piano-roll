document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        let connector = new Connector();
        var output = new PianoKeyboard({ width: 1232, height: 200 }, Notes.fromString('A1'), Notes.fromString('C9'));
        connector.addOutput(output);
        if (MidiUtils.inputs.length > 0) {
            var input = MidiUtils.createInput('defaultMidi', 0);
            connector.addInput(input);
        }
        window['output'] = output;
        window['piano'] = MidiUtils.createOutput('piano', 0);
    });
});
class Input {
    constructor(id) {
        this.id = id;
    }
    send(m) {
        if (this.onSend != null) {
            this.onSend(m);
        }
    }
}
class Notes {
    static latinName(p) {
        return Notes.latinNames[p];
    }
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.pitchClass;
    }
    static forNumber(n) {
        return { octave: n / 12 + 4, pitchClass: n % 12 };
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
    static toString(p) {
        return PitchClass[p.pitchClass].replace('s', '#') + p.octave;
    }
    static fromString(s) {
        var p = new Pitch();
        p.octave = parseInt(s.substring(s.length - 1));
        p.pitchClass = PitchClass[s.substring(0, s.length - 1).replace('#', 's')];
        return p;
    }
}
Notes.defaultVelocity = 0.7;
Notes.latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
class Output {
    constructor(id) {
        this.id = id;
    }
}
var PitchClass;
(function (PitchClass) {
    PitchClass[PitchClass["C"] = 0] = "C";
    PitchClass[PitchClass["Cs"] = 1] = "Cs";
    PitchClass[PitchClass["D"] = 2] = "D";
    PitchClass[PitchClass["Ds"] = 3] = "Ds";
    PitchClass[PitchClass["E"] = 4] = "E";
    PitchClass[PitchClass["F"] = 5] = "F";
    PitchClass[PitchClass["Fs"] = 6] = "Fs";
    PitchClass[PitchClass["G"] = 7] = "G";
    PitchClass[PitchClass["Gs"] = 8] = "Gs";
    PitchClass[PitchClass["A"] = 9] = "A";
    PitchClass[PitchClass["As"] = 10] = "As";
    PitchClass[PitchClass["B"] = 11] = "B";
})(PitchClass || (PitchClass = {}));
var Accidental;
(function (Accidental) {
    Accidental[Accidental["Natural"] = 0] = "Natural";
    Accidental[Accidental["Sharp"] = 1] = "Sharp";
    Accidental[Accidental["Flat"] = 2] = "Flat";
})(Accidental || (Accidental = {}));
var DurationType;
(function (DurationType) {
    DurationType[DurationType["Real"] = 0] = "Real";
    DurationType[DurationType["Sheet"] = 1] = "Sheet";
})(DurationType || (DurationType = {}));
class Pitch {
}
class Note {
}
class Connector {
    constructor() {
        this.inputs = [];
        this.outputs = [];
    }
    addInput(i) {
        this.inputs.push(i);
        i.onSend = (m) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.receive(m);
                }
            });
        };
    }
    addOutput(o) {
        this.outputs.push(o);
    }
}
class Keyboard extends Input {
    constructor() {
        super('keyboard');
        this.velocity = Notes.defaultVelocity;
        this.channel = 1;
        window.onkeydown = evt => this.send({
            type: 'start',
            pitch: this.forKey(evt.which),
            velocity: this.velocity,
            channel: this.channel
        });
        window.onkeyup = evt => this.send({
            type: 'stop',
            pitch: this.forKey(evt.which)
        });
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="../ext/webmidi.d.ts" />
class MidiMessage {
}
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n) {
        return new MidiInput(id, this.inputs[n]);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return { octave: Math.trunc(code / 12), pitchClass: code % 12 };
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.pitchClass;
    }
}
MidiUtils.enabled = false;
class MidiInput extends Input {
    constructor(id, input) {
        super(id);
        this.input = input;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            console.log(evt.data, m, pitch, Notes.toString(pitch));
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                this.send({
                    type: 'stop',
                    pitch: pitch
                });
            }
            else if (m.type == 144) {
                this.send({
                    type: 'start',
                    pitch: pitch,
                    velocity: m.velocity / 127,
                    channel: 1
                });
            }
        };
    }
}
class MidiOutput extends Output {
    constructor(id, output) {
        super(id);
        this.output = output;
    }
    start(p, velocity) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: Math.trunc(velocity * 127) // 
        }));
    }
    stop(p) {
        this.output.send(MidiUtils.encode({
            command: 9,
            channel: 0,
            type: 144,
            note: MidiUtils.fromPitch(p),
            velocity: 0
        }));
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: Math.trunc(m.velocity * 127) // 
            }));
            case 'stop': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: 0
            }));
        }
    }
}
class Oscillator extends Output {
    constructor(type) {
        super('oscillator');
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch, velocity) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                this.osc.frequency.value = Notes.frequency(m.pitch);
                this.osc.start();
                break;
            case 'stop':
                this.osc.stop();
                break;
        }
    }
}
class OutputChorus extends Output {
    constructor(id, output, delay, decay, times) {
        super(id);
        this.output = output;
        this.delay = delay;
        this.decay = decay;
        this.times = times;
    }
    start(pitch, velocity) {
        for (var i = 0; i < this.times; i++) {
            velocity *= this.decay;
            setTimeout(() => this.output.start(pitch, velocity, this.delay * (i + 1)));
        }
    }
    stop(pitch) {
        setTimeout(() => this.output.stop(pitch), this.delay * (this.times + 1));
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                let velocity = m.velocity;
                for (let i = 0; i < this.times; i++) {
                    velocity *= this.decay;
                    setTimeout(() => this.output.start(m.pitch, velocity, this.delay * (i + 1)));
                }
                break;
            case 'stop':
                setTimeout(() => this.output.stop(m.pitch), this.delay * (this.times + 1));
                break;
        }
    }
}
class PianoKeyboard extends Output {
    constructor(dim, first, last) {
        super('pianoKeyboard');
        this.keysPainted = [];
        this.dim = dim;
        this.canvas = Snap(dim.width, dim.height);
        this.firstKey = Notes.asNumber(first);
        this.keyLength = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(dim.width / this.keyLength);
        this.blackKeyWidth = this.whiteKeyWidth * 0.7;
        this.drawKeys();
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.drawPressed(m.pitch, 'red');
            case 'stop': return this.drawPressed(m.pitch, 'white');
        }
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        var attrs = { fill: '#fff', stroke: '#000', strokeWidth: 1 };
        for (let key = 0; key < this.keyLength; key++) {
            let start = key * this.whiteKeyWidth;
            let rect = this.canvas.rect(start, 0, this.whiteKeyWidth, this.dim.height);
            rect.attr(attrs);
            this.keysPainted.push(rect);
            rect.data('key', key);
        }
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.firstKey;
        let key = this.keysPainted[n];
        key.attr({ fill: color });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvaW5wdXQudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvbm90ZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvb3V0cHV0LnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL21lc3NhZ2VzLnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL3R5cGVzLnRzIiwiLi4vdHlwZXNjcmlwdC9pbXBsL0Nvbm5lY3Rvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvT3NjaWxsYXRvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9PdXRwdXRDaG9ydXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUU7SUFDMUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQztRQUV4QixJQUFJLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBSWhDLElBQUksTUFBTSxHQUFHLElBQUksYUFBYSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0csU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUc1QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksS0FBSyxHQUFHLFNBQVMsQ0FBQyxXQUFXLENB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QUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBUTFCLENBQUM7SUFDTCxDQUFDO0lBRU8sV0FBVyxDQUFDLENBQVEsRUFBRSxLQUFhO1FBQ3ZDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUMxQyxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUM5QixDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gICAgTWlkaVV0aWxzLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcblxuICAgICAgICBsZXQgY29ubmVjdG9yID0gbmV3IENvbm5lY3RvcigpO1xuXG5cblxuICAgICAgICB2YXIgb3V0cHV0ID0gbmV3IFBpYW5vS2V5Ym9hcmQoeyB3aWR0aDogMTIzMiwgaGVpZ2h0OiAyMDAgfSwgTm90ZXMuZnJvbVN0cmluZygnQTEnKSwgTm90ZXMuZnJvbVN0cmluZygnQzknKSk7XG4gICAgICAgIGNvbm5lY3Rvci5hZGRPdXRwdXQob3V0cHV0KTtcblxuXG4gICAgICAgIGlmIChNaWRpVXRpbHMuaW5wdXRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHZhciBpbnB1dCA9IE1pZGlVdGlscy5jcmVhdGVJbnB1dCgnZGVmYXVsdE1pZGknLCAwKTtcbiAgICAgICAgICAgIGNvbm5lY3Rvci5hZGRJbnB1dChpbnB1dCk7XG4gICAgICAgIH1cbiAgICAgICAgd2luZG93WydvdXRwdXQnXSA9IG91dHB1dDtcbiAgICAgICAgd2luZG93WydwaWFubyddID0gTWlkaVV0aWxzLmNyZWF0ZU91dHB1dCgncGlhbm8nLCAwKTtcbiAgICB9KTtcbn0pOyIsImFic3RyYWN0IGNsYXNzIElucHV0IHtcblxuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gICAgb25TZW5kOiAoKG06IE1lc3NhZ2UpID0+IGFueSkgfCBudWxsO1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHNlbmQobTogTWVzc2FnZSkge1xuICAgICAgICBpZiAodGhpcy5vblNlbmQgIT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5vblNlbmQobSk7XG4gICAgICAgIH1cbiAgICB9XG5cbn0iLCJhYnN0cmFjdCBjbGFzcyBOb3RlcyB7XG5cbiAgICBzdGF0aWMgcmVhZG9ubHkgZGVmYXVsdFZlbG9jaXR5ID0gMC43O1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgbGF0aW5OYW1lcyA9IFsnRG8nLCAnRG8jJywgJ1JlJywgJ1JlIycsICdNaScsICdGYScsICdGYSMnLCAnU29sJywgJ1NvbCMnLCAnTGEnLCAnTGEjJywgJ1NpJ107XG5cblxuICAgIHN0YXRpYyBsYXRpbk5hbWUocDogUGl0Y2hDbGFzcyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5sYXRpbk5hbWVzW3BdO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc051bWJlcihwOiBQaXRjaCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAocC5vY3RhdmUgLSA0KSAqIDEyICsgcC5waXRjaENsYXNzO1xuICAgIH1cblxuICAgIHN0YXRpYyBmb3JOdW1iZXIobjogbnVtYmVyKTogUGl0Y2gge1xuICAgICAgICByZXR1cm4geyBvY3RhdmU6IG4gLyAxMiArIDQsIHBpdGNoQ2xhc3M6IG4gJSAxMiB9XG4gICAgfVxuXG4gICAgc3RhdGljIGZyZXF1ZW5jeShwOiBQaXRjaCkge1xuICAgICAgICByZXR1cm4gTWF0aC5wb3coMiwgKE5vdGVzLmFzTnVtYmVyKHApIC0gNDkpIC8gMTIpICogNDQwO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1N0cmluZyhwOiBQaXRjaCkge1xuICAgICAgICByZXR1cm4gUGl0Y2hDbGFzc1twLnBpdGNoQ2xhc3NdLnJlcGxhY2UoJ3MnLCAnIycpICsgcC5vY3RhdmU7XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21TdHJpbmcoczogc3RyaW5nKSB7XG4gICAgICAgIHZhciBwID0gbmV3IFBpdGNoKCk7XG4gICAgICAgIHAub2N0YXZlID0gcGFyc2VJbnQocy5zdWJzdHJpbmcocy5sZW5ndGggLSAxKSk7XG4gICAgICAgIHAucGl0Y2hDbGFzcyA9IFBpdGNoQ2xhc3Nbcy5zdWJzdHJpbmcoMCwgcy5sZW5ndGggLSAxKS5yZXBsYWNlKCcjJywgJ3MnKV07XG4gICAgICAgIHJldHVybiBwO1xuICAgIH1cblxufVxuIiwiYWJzdHJhY3QgY2xhc3MgT3V0cHV0IHtcblxuICAgIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihpZCkge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgfVxuXG4gICAgYWJzdHJhY3QgcmVjZWl2ZShtOiBNZXNzYWdlKTogdm9pZDtcblxufSIsInR5cGUgTWVzc2FnZSA9XG4gICAge1xuICAgICAgICB0eXBlOiAnc3RhcnQnLFxuICAgICAgICBwaXRjaDogUGl0Y2gsXG4gICAgICAgIGNoYW5uZWw6IG51bWJlcixcbiAgICAgICAgdmVsb2NpdHk6IG51bWJlclxuICAgIH0gfCB7XG4gICAgICAgIHR5cGU6ICdzdG9wJyxcbiAgICAgICAgcGl0Y2g6IFBpdGNoXG4gICAgfTsiLCJlbnVtIFBpdGNoQ2xhc3Mge1xuICAgIEMsIENzLCBELCBEcywgRSwgRiwgRnMsIEcsIEdzLCBBLCBBcywgQlxufVxuXG5lbnVtIEFjY2lkZW50YWwge1xuICAgIE5hdHVyYWwsIFNoYXJwLCBGbGF0XG59XG5cbmVudW0gRHVyYXRpb25UeXBlIHtcbiAgICBSZWFsLCBTaGVldFxufVxuXG5jbGFzcyBQaXRjaCB7XG4gICAgcGl0Y2hDbGFzczogUGl0Y2hDbGFzcztcbiAgICBvY3RhdmU6IG51bWJlcjtcbn1cblxuY2xhc3MgTm90ZSB7XG4gICAgcGl0Y2g6IFBpdGNoO1xuICAgIHZlbG9jaXR5OiBudW1iZXI7XG4gICAgZHVyYXRpb246IG51bWJlciB8IG51bGw7XG59XG5cbnR5cGUgRGltZW5zaW9ucyA9IHsgd2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIgfTtcblxuXG4iLCJjbGFzcyBDb25uZWN0b3Ige1xuXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGlucHV0czogSW5wdXRbXSA9IFtdO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBvdXRwdXRzOiBPdXRwdXRbXSA9IFtdO1xuXG4gICAgYWRkSW5wdXQoaTogSW5wdXQpIHtcbiAgICAgICAgdGhpcy5pbnB1dHMucHVzaChpKTtcbiAgICAgICAgaS5vblNlbmQgPSAobTogTWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXRzLmZvckVhY2gobyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG8uaWQgIT0gaS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBvLnJlY2VpdmUobSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRPdXRwdXQobzogT3V0cHV0KSB7XG4gICAgICAgIHRoaXMub3V0cHV0cy5wdXNoKG8pO1xuICAgIH1cblxufSIsImNsYXNzIEtleWJvYXJkIGV4dGVuZHMgSW5wdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlzOiAnenN4ZGN2Z2JobmptcTJ3M2VyNXQ2eTd1aTlvMHAnO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdmVsb2NpdHk6IG51bWJlciA9IE5vdGVzLmRlZmF1bHRWZWxvY2l0eTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNoYW5uZWw6IG51bWJlciA9IDE7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoJ2tleWJvYXJkJyk7XG5cbiAgICAgICAgd2luZG93Lm9ua2V5ZG93biA9IGV2dCA9PiB0aGlzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ3N0YXJ0JyxcbiAgICAgICAgICAgIHBpdGNoOiB0aGlzLmZvcktleShldnQud2hpY2gpLFxuICAgICAgICAgICAgdmVsb2NpdHk6IHRoaXMudmVsb2NpdHksXG4gICAgICAgICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWxcbiAgICAgICAgfSk7XG4gICAgICAgIHdpbmRvdy5vbmtleXVwID0gZXZ0ID0+IHRoaXMuc2VuZCh7XG4gICAgICAgICAgICB0eXBlOiAnc3RvcCcsXG4gICAgICAgICAgICBwaXRjaDogdGhpcy5mb3JLZXkoZXZ0LndoaWNoKVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcktleShuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5mb3JOdW1iZXIobik7XG4gICAgfVxuXG59ICIsIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9leHQvd2VibWlkaS5kLnRzXCIgLz5cblxuY2xhc3MgTWlkaU1lc3NhZ2Uge1xuICAgIGNvbW1hbmQ6IG51bWJlcjtcbiAgICBjaGFubmVsOiBudW1iZXI7XG4gICAgdHlwZTogbnVtYmVyO1xuICAgIG5vdGU6IG51bWJlcjtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xufVxuXG5jbGFzcyBNaWRpVXRpbHMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZW5hYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIGluZm86IFdlYk1pZGkuTUlESUFjY2VzcztcbiAgICBzdGF0aWMgb3V0cHV0czogQXJyYXk8V2ViTWlkaS5NSURJT3V0cHV0PjtcbiAgICBzdGF0aWMgaW5wdXRzOiBBcnJheTxXZWJNaWRpLk1JRElJbnB1dD47XG5cbiAgICBzdGF0aWMgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yLnJlcXVlc3RNSURJQWNjZXNzKCkudGhlbihcbiAgICAgICAgICAgICAgICAgICAgeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5mbyA9IHg7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5wdXRzID0gQXJyYXkuZnJvbSh4LmlucHV0cy52YWx1ZXMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMub3V0cHV0cyA9IEFycmF5LmZyb20oeC5vdXRwdXRzLnZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgTWlkaVV0aWxzLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZGVjb2RlKGRhdGE6IFVpbnQ4QXJyYXkpOiBNaWRpTWVzc2FnZSB7XG4gICAgICAgIHZhciBtID0gbmV3IE1pZGlNZXNzYWdlKCk7XG4gICAgICAgIG0uY29tbWFuZCA9IGRhdGFbMF0gPj4gNDtcbiAgICAgICAgbS5jaGFubmVsID0gZGF0YVswXSAmIDB4ZjtcbiAgICAgICAgbS50eXBlID0gZGF0YVswXSAmIDB4ZjA7XG4gICAgICAgIG0ubm90ZSA9IGRhdGFbMV07XG4gICAgICAgIG0udmVsb2NpdHkgPSBkYXRhWzJdO1xuICAgICAgICByZXR1cm4gbTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGVuY29kZShtOiBNaWRpTWVzc2FnZSkge1xuICAgICAgICB2YXIgeCA9IChtLmNoYW5uZWwgJiAweGYpIHwgKG0udHlwZSAmIDB4ZjApIHwgKG0uY29tbWFuZCA8PCA0KTtcbiAgICAgICAgcmV0dXJuIFt4LCBtLm5vdGUsIG0udmVsb2NpdHldO1xuICAgIH07XG5cbiAgICBzdGF0aWMgY3JlYXRlSW5wdXQoaWQ6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaUlucHV0KGlkLCB0aGlzLmlucHV0c1tuXSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZU91dHB1dChpZDogc3RyaW5nLCBuOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBNaWRpT3V0cHV0KGlkLCB0aGlzLm91dHB1dHNbbl0pO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1BpdGNoKGNvZGU6IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIHsgb2N0YXZlOiBNYXRoLnRydW5jKGNvZGUgLyAxMiksIHBpdGNoQ2xhc3M6IGNvZGUgJSAxMiB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tUGl0Y2gocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHJldHVybiBwaXRjaC5vY3RhdmUgKiAxMiArIHBpdGNoLnBpdGNoQ2xhc3M7XG4gICAgfVxuXG59XG5cblxuXG5jbGFzcyBNaWRpSW5wdXQgZXh0ZW5kcyBJbnB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dDtcblxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dCkge1xuICAgICAgICBzdXBlcihpZCk7XG4gICAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcblxuICAgICAgICB0aGlzLmlucHV0Lm9ubWlkaW1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgdmFyIG0gPSBNaWRpVXRpbHMuZGVjb2RlKGV2dC5kYXRhKTtcbiAgICAgICAgICAgIHZhciBwaXRjaCA9IE1pZGlVdGlscy50b1BpdGNoKG0ubm90ZSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldnQuZGF0YSwgbSwgcGl0Y2gsIE5vdGVzLnRvU3RyaW5nKHBpdGNoKSk7XG4gICAgICAgICAgICBpZiAobS50eXBlID09IDEyOCB8fCAobS50eXBlID09IDE0NCAmJiBtLnZlbG9jaXR5ID09IDApKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3N0b3AnLFxuICAgICAgICAgICAgICAgICAgICBwaXRjaDogcGl0Y2hcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobS50eXBlID09IDE0NCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFydCcsXG4gICAgICAgICAgICAgICAgICAgIHBpdGNoOiBwaXRjaCxcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IG0udmVsb2NpdHkgLyAxMjcsXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgTWlkaU91dHB1dCBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogV2ViTWlkaS5NSURJT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICB9XG5cbiAgICBzdGFydChwOiBQaXRjaCwgdmVsb2NpdHk6IG51bWJlcikge1xuICAgICAgICB0aGlzLm91dHB1dC5zZW5kKE1pZGlVdGlscy5lbmNvZGUoeyAvL1xuICAgICAgICAgICAgY29tbWFuZDogOSwgLy9cbiAgICAgICAgICAgIGNoYW5uZWw6IDAsIC8vXG4gICAgICAgICAgICB0eXBlOiAxNDQsIC8vXG4gICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKHApLCAvLyBcbiAgICAgICAgICAgIHZlbG9jaXR5OiBNYXRoLnRydW5jKHZlbG9jaXR5ICogMTI3KSAvLyBcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIHN0b3AocDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5vdXRwdXQuc2VuZChNaWRpVXRpbHMuZW5jb2RlKHsgLy9cbiAgICAgICAgICAgIGNvbW1hbmQ6IDksIC8vXG4gICAgICAgICAgICBjaGFubmVsOiAwLCAvL1xuICAgICAgICAgICAgdHlwZTogMTQ0LCAvL1xuICAgICAgICAgICAgbm90ZTogTWlkaVV0aWxzLmZyb21QaXRjaChwKSwgLy8gXG4gICAgICAgICAgICB2ZWxvY2l0eTogMFxuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIHN3aXRjaCAobS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdGFydCc6IHJldHVybiB0aGlzLm91dHB1dC5zZW5kKE1pZGlVdGlscy5lbmNvZGUoeyAvL1xuICAgICAgICAgICAgICAgIGNvbW1hbmQ6IDksIC8vXG4gICAgICAgICAgICAgICAgY2hhbm5lbDogMCwgLy9cbiAgICAgICAgICAgICAgICB0eXBlOiAxNDQsIC8vXG4gICAgICAgICAgICAgICAgbm90ZTogTWlkaVV0aWxzLmZyb21QaXRjaChtLnBpdGNoKSwgLy8gXG4gICAgICAgICAgICAgICAgdmVsb2NpdHk6IE1hdGgudHJ1bmMobS52ZWxvY2l0eSAqIDEyNykgLy8gXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICBjYXNlICdzdG9wJzogcmV0dXJuIHRoaXMub3V0cHV0LnNlbmQoTWlkaVV0aWxzLmVuY29kZSh7IC8vXG4gICAgICAgICAgICAgICAgY29tbWFuZDogOSxcbiAgICAgICAgICAgICAgICBjaGFubmVsOiAwLFxuICAgICAgICAgICAgICAgIHR5cGU6IDE0NCxcbiAgICAgICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKG0ucGl0Y2gpLFxuICAgICAgICAgICAgICAgIHZlbG9jaXR5OiAwXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbn0iLCJ0eXBlIFdhdmVUeXBlID0gJ3NpbmUnIHwgJ3NxdWFyZScgfCAnc2F3dG9vdGgnIHwgJ3RyaWFuZ2xlJztcblxuY2xhc3MgT3NjaWxsYXRvciBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG9zYzogT3NjaWxsYXRvck5vZGU7XG5cbiAgICBjb25zdHJ1Y3Rvcih0eXBlOiBXYXZlVHlwZSkge1xuICAgICAgICBzdXBlcignb3NjaWxsYXRvcicpO1xuICAgICAgICB2YXIgY3R4ID0gbmV3IEF1ZGlvQ29udGV4dCgpO1xuICAgICAgICB0aGlzLm9zYyA9IGN0eC5jcmVhdGVPc2NpbGxhdG9yKCk7XG4gICAgICAgIHRoaXMub3NjLnR5cGUgPSB0eXBlO1xuICAgICAgICB0aGlzLm9zYy5jb25uZWN0KGN0eC5kZXN0aW5hdGlvbik7XG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoLCB2ZWxvY2l0eTogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMub3NjLmZyZXF1ZW5jeS52YWx1ZSA9IE5vdGVzLmZyZXF1ZW5jeShwaXRjaCk7XG4gICAgICAgIHRoaXMub3NjLnN0YXJ0KCk7XG4gICAgfVxuXG4gICAgc3RvcChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5vc2Muc3RvcCgpO1xuICAgIH1cblxuICAgIHJlY2VpdmUobTogTWVzc2FnZSkge1xuICAgICAgICBzd2l0Y2ggKG0udHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnc3RhcnQnOlxuICAgICAgICAgICAgICAgIHRoaXMub3NjLmZyZXF1ZW5jeS52YWx1ZSA9IE5vdGVzLmZyZXF1ZW5jeShtLnBpdGNoKTtcbiAgICAgICAgICAgICAgICB0aGlzLm9zYy5zdGFydCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnc3RvcCc6IHRoaXMub3NjLnN0b3AoKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxufSIsImNsYXNzIE91dHB1dENob3J1cyBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogYW55O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVsYXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlY2F5OiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSB0aW1lczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3IoaWQsIG91dHB1dDogT3V0cHV0LCBkZWxheTogbnVtYmVyLCBkZWNheTogbnVtYmVyLCB0aW1lczogbnVtYmVyKSB7XG4gICAgICAgIHN1cGVyKGlkKTtcbiAgICAgICAgdGhpcy5vdXRwdXQgPSBvdXRwdXQ7XG4gICAgICAgIHRoaXMuZGVsYXkgPSBkZWxheTtcbiAgICAgICAgdGhpcy5kZWNheSA9IGRlY2F5O1xuICAgICAgICB0aGlzLnRpbWVzID0gdGltZXM7XG4gICAgfVxuXG4gICAgc3RhcnQocGl0Y2g6IFBpdGNoLCB2ZWxvY2l0eSkge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGltZXM7IGkrKykge1xuICAgICAgICAgICAgdmVsb2NpdHkgKj0gdGhpcy5kZWNheTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RhcnQocGl0Y2gsIHZlbG9jaXR5LCB0aGlzLmRlbGF5ICogKGkgKyAxKSkpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMub3V0cHV0LnN0b3AocGl0Y2gpLCB0aGlzLmRlbGF5ICogKHRoaXMudGltZXMgKyAxKSk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIHN3aXRjaCAobS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdGFydCc6XG4gICAgICAgICAgICAgICAgbGV0IHZlbG9jaXR5ID0gbS52ZWxvY2l0eTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudGltZXM7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eSAqPSB0aGlzLmRlY2F5O1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMub3V0cHV0LnN0YXJ0KG0ucGl0Y2gsIHZlbG9jaXR5LCB0aGlzLmRlbGF5ICogKGkgKyAxKSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3N0b3AnOlxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RvcChtLnBpdGNoKSwgdGhpcy5kZWxheSAqICh0aGlzLnRpbWVzICsgMSkpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG59IiwiXG5jbGFzcyBQaWFub0tleWJvYXJkIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGltOiBEaW1lbnNpb25zO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzOiBTbmFwLlBhcGVyO1xuXG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGtleUxlbmd0aDogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZmlyc3RLZXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHdoaXRlS2V5V2lkdGg6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGJsYWNrS2V5V2lkdGg6IG51bWJlcjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkga2V5c1BhaW50ZWQ6IEFycmF5PFNuYXAuRWxlbWVudD4gPSBbXTtcblxuXG5cbiAgICBjb25zdHJ1Y3RvcihkaW06IERpbWVuc2lvbnMsIGZpcnN0OiBQaXRjaCwgbGFzdDogUGl0Y2gpIHtcbiAgICAgICAgc3VwZXIoJ3BpYW5vS2V5Ym9hcmQnKTtcblxuICAgICAgICB0aGlzLmRpbSA9IGRpbTtcbiAgICAgICAgdGhpcy5jYW52YXMgPSBTbmFwKGRpbS53aWR0aCwgZGltLmhlaWdodCk7XG5cblxuICAgICAgICB0aGlzLmZpcnN0S2V5ID0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpO1xuICAgICAgICB0aGlzLmtleUxlbmd0aCA9IE5vdGVzLmFzTnVtYmVyKGxhc3QpIC0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpICsgMTtcblxuICAgICAgICB0aGlzLndoaXRlS2V5V2lkdGggPSBNYXRoLnRydW5jKGRpbS53aWR0aCAvIHRoaXMua2V5TGVuZ3RoKTtcbiAgICAgICAgdGhpcy5ibGFja0tleVdpZHRoID0gdGhpcy53aGl0ZUtleVdpZHRoICogMC43O1xuXG4gICAgICAgIHRoaXMuZHJhd0tleXMoKTtcbiAgICB9XG5cbiAgICByZWNlaXZlKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChtLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0JzogcmV0dXJuIHRoaXMuZHJhd1ByZXNzZWQobS5waXRjaCwgJ3JlZCcpO1xuICAgICAgICAgICAgY2FzZSAnc3RvcCc6IHJldHVybiB0aGlzLmRyYXdQcmVzc2VkKG0ucGl0Y2gsICd3aGl0ZScpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RvcChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgdGhpcy5kcmF3UHJlc3NlZChwaXRjaCwgJ3doaXRlJyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3S2V5cygpIHtcbiAgICAgICAgdmFyIGF0dHJzID0geyBmaWxsOiAnI2ZmZicsIHN0cm9rZTogJyMwMDAnLCBzdHJva2VXaWR0aDogMSB9O1xuICAgICAgICBmb3IgKGxldCBrZXkgPSAwOyBrZXkgPCB0aGlzLmtleUxlbmd0aDsga2V5KyspIHtcbiAgICAgICAgICAgIGxldCBzdGFydCA9IGtleSAqIHRoaXMud2hpdGVLZXlXaWR0aDtcbiAgICAgICAgICAgIGxldCByZWN0ID0gdGhpcy5jYW52YXMucmVjdChzdGFydCwgMCwgdGhpcy53aGl0ZUtleVdpZHRoLCB0aGlzLmRpbS5oZWlnaHQpO1xuICAgICAgICAgICAgcmVjdC5hdHRyKGF0dHJzKTtcbiAgICAgICAgICAgIHRoaXMua2V5c1BhaW50ZWQucHVzaChyZWN0KTtcbiAgICAgICAgICAgIHJlY3QuZGF0YSgna2V5Jywga2V5KTtcblxuXG5cbiAgICAgICAgICAgIC8vICAgICAgICAgICAgcmVjdC5jbGljaygoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCBldmVudCk7XG4gICAgICAgICAgICAvLyAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3UHJlc3NlZChwOiBQaXRjaCwgY29sb3I6IHN0cmluZykge1xuICAgICAgICBsZXQgbiA9IE5vdGVzLmFzTnVtYmVyKHApIC0gdGhpcy5maXJzdEtleTtcbiAgICAgICAgbGV0IGtleSA9IHRoaXMua2V5c1BhaW50ZWRbbl07XG4gICAgICAgIGtleS5hdHRyKHsgZmlsbDogY29sb3IgfSk7XG4gICAgfVxuXG59Il19