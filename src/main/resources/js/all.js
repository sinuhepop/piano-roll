document.addEventListener('DOMContentLoaded', function () {
    MidiUtils.initialize().then(() => {
        let connector = new Connector();
        connector.addOutput(new Logger());
        let piano = new PianoKeyboard({ width: 1232, height: 120 }, Pitch.fromString('A1'), Pitch.fromString('C9'));
        connector.addInput(piano);
        connector.addOutput(piano);
        if (MidiUtils.inputs.length > 0) {
            connector.addInput(MidiUtils.createInput('midi', 0));
            connector.addOutput(MidiUtils.createOutput('midi', 0));
        }
    });
});
class Input {
    constructor(id) {
        this.id = id;
    }
    send(m) {
        if (this.onSend != null) {
            this.onSend(m);
        }
    }
}
class Notes {
    static asNumber(p) {
        return (p.octave - 4) * 12 + p.class;
    }
    static forNumber(n) {
        return new Pitch(Math.floor(n / 12 + 4), (n % 12 + 12) % 12);
    }
    static frequency(p) {
        return Math.pow(2, (Notes.asNumber(p) - 49) / 12) * 440;
    }
}
Notes.defaultVelocity = 0.5;
class Output {
    constructor(id) {
        this.id = id;
    }
}
const englishNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const latinNames = ['Do', 'Do#', 'Re', 'Re#', 'Mi', 'Fa', 'Fa#', 'Sol', 'Sol#', 'La', 'La#', 'Si'];
const diatonic = [0, 2, 4, 5, 7, 9, 11];
/*
enum Accidental {
    Natural, Sharp, Flat
}

enum DurationType {
    Real, Sheet
}
*/
class Pitch {
    constructor(octave, clss) {
        this.octave = octave;
        this.class = clss;
    }
    toString() {
        return englishNames[this.class] + this.octave;
    }
    isDiatonic() {
        return diatonic.indexOf(this.class) > -1;
    }
    static fromString(s) {
        var octave = parseInt(s.substring(s.length - 1));
        var clss = englishNames.indexOf(s.substring(0, s.length - 1));
        return new Pitch(octave, clss);
    }
}
class Connector {
    constructor() {
        this.inputs = [];
        this.outputs = [];
    }
    addInput(i) {
        this.inputs.push(i);
        i.onSend = (m) => {
            this.outputs.forEach(o => {
                if (o.id != i.id) {
                    o.receive(m);
                }
            });
        };
    }
    addOutput(o) {
        this.outputs.push(o);
    }
}
class Keyboard extends Input {
    constructor() {
        super('keyboard');
        this.velocity = Notes.defaultVelocity;
        this.channel = 1;
        window.onkeydown = evt => this.send({
            type: 'start',
            pitch: this.forKey(evt.which),
            velocity: this.velocity,
            channel: this.channel
        });
        window.onkeyup = evt => this.send({
            type: 'stop',
            pitch: this.forKey(evt.which)
        });
    }
    forKey(n) {
        return Notes.forNumber(n);
    }
}
/// <reference path="../ext/webmidi.d.ts" />
class MidiMessage {
}
class MidiUtils {
    static initialize() {
        return new Promise((resolve, reject) => {
            try {
                navigator.requestMIDIAccess().then(x => {
                    MidiUtils.info = x;
                    MidiUtils.inputs = Array.from(x.inputs.values());
                    MidiUtils.outputs = Array.from(x.outputs.values());
                    MidiUtils.enabled = true;
                    resolve();
                });
            }
            catch (e) {
                MidiUtils.enabled = false;
                reject(e);
            }
        });
    }
    ;
    static decode(data) {
        var m = new MidiMessage();
        m.command = data[0] >> 4;
        m.channel = data[0] & 0xf;
        m.type = data[0] & 0xf0;
        m.note = data[1];
        m.velocity = data[2];
        return m;
    }
    ;
    static encode(m) {
        var x = (m.channel & 0xf) | (m.type & 0xf0) | (m.command << 4);
        return [x, m.note, m.velocity];
    }
    ;
    static createInput(id, n) {
        return new MidiInput(id, this.inputs[n]);
    }
    static createOutput(id, n) {
        return new MidiOutput(id, this.outputs[n]);
    }
    static toPitch(code) {
        return new Pitch(Math.trunc(code / 12), code % 12);
    }
    static fromPitch(pitch) {
        return pitch.octave * 12 + pitch.class;
    }
}
MidiUtils.enabled = false;
class MidiInput extends Input {
    constructor(id, input) {
        super(id);
        this.input = input;
        this.input.onmidimessage = evt => {
            var m = MidiUtils.decode(evt.data);
            var pitch = MidiUtils.toPitch(m.note);
            if (m.type == 128 || (m.type == 144 && m.velocity == 0)) {
                this.send({
                    type: 'stop',
                    pitch: pitch
                });
            }
            else if (m.type == 144) {
                this.send({
                    type: 'start',
                    pitch: pitch,
                    velocity: Math.trunc(m.velocity / 127),
                    channel: 1
                });
            }
        };
    }
}
class MidiOutput extends Output {
    constructor(id, output) {
        super(id);
        this.output = output;
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: Math.trunc(m.velocity * 127) // 
            }));
            case 'stop': return this.output.send(MidiUtils.encode({
                command: 9,
                channel: 0,
                type: 144,
                note: MidiUtils.fromPitch(m.pitch),
                velocity: 0
            }));
        }
    }
}
class Oscillator extends Output {
    constructor(type) {
        super('oscillator');
        var ctx = new AudioContext();
        this.osc = ctx.createOscillator();
        this.osc.type = type;
        this.osc.connect(ctx.destination);
    }
    start(pitch, velocity) {
        this.osc.frequency.value = Notes.frequency(pitch);
        this.osc.start();
    }
    stop(pitch) {
        this.osc.stop();
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                this.osc.frequency.value = Notes.frequency(m.pitch);
                this.osc.start();
                break;
            case 'stop':
                this.osc.stop();
                break;
        }
    }
}
class OutputChorus extends Output {
    constructor(id, output, delay, decay, times) {
        super(id);
        this.output = output;
        this.delay = delay;
        this.decay = decay;
        this.times = times;
    }
    start(pitch, velocity) {
        for (var i = 0; i < this.times; i++) {
            velocity *= this.decay;
            setTimeout(() => this.output.start(pitch, velocity, this.delay * (i + 1)));
        }
    }
    stop(pitch) {
        setTimeout(() => this.output.stop(pitch), this.delay * (this.times + 1));
    }
    receive(m) {
        switch (m.type) {
            case 'start':
                let velocity = m.velocity;
                for (let i = 0; i < this.times; i++) {
                    velocity *= this.decay;
                    setTimeout(() => this.output.start(m.pitch, velocity, this.delay * (i + 1)));
                }
                break;
            case 'stop':
                setTimeout(() => this.output.stop(m.pitch), this.delay * (this.times + 1));
                break;
        }
    }
}
class PianoKeyboard extends Input {
    constructor(dim, first, last) {
        super('pianoKeyboard');
        this.keysPainted = [];
        this.dim = dim;
        this.canvas = Snap(dim.width, dim.height);
        this.firstKey = Notes.asNumber(first);
        this.keyLength = Notes.asNumber(last) - Notes.asNumber(first) + 1;
        this.whiteKeyWidth = Math.trunc(dim.width / this.keyLength);
        this.blackKeyWidth = this.whiteKeyWidth * PianoKeyboard.blackKeyWidthRatio;
        this.drawKeys();
    }
    receive(m) {
        switch (m.type) {
            case 'start': return this.drawPressed(m.pitch, 'red');
            case 'stop': return this.drawPressed(m.pitch, 'white');
        }
    }
    stop(pitch) {
        this.drawPressed(pitch, 'white');
    }
    drawKeys() {
        let attrs = { fill: '#fff', stroke: '#000', strokeWidth: 1 };
        for (let key = 0; key < this.keyLength; key++) {
            let start = key * this.whiteKeyWidth;
            let rect = this.canvas.rect(start, 0, this.whiteKeyWidth, this.dim.height);
            rect.attr(attrs);
            this.keysPainted.push(rect);
            rect.data('key', key);
            rect.click((event) => {
                this.send({
                    type: 'start',
                    pitch: Notes.forNumber(key + this.firstKey),
                    velocity: Notes.defaultVelocity,
                    channel: 1
                });
            });
        }
        attrs = { fill: '#000', stroke: '#000', strokeWidth: 1 };
        for (let key = 1; key < this.keyLength; key++) {
            let start = key * this.whiteKeyWidth - 0.5 * this.blackKeyWidth;
            let rect = this.canvas.rect(start, 0, this.blackKeyWidth, this.dim.height * PianoKeyboard.blackKeyHeightRatio);
            rect.attr(attrs);
            this.keysPainted.push(rect);
        }
    }
    drawPressed(p, color) {
        let n = Notes.asNumber(p) - this.firstKey;
        let key = this.keysPainted[n];
        key.attr({ fill: color });
    }
}
PianoKeyboard.blackKeyHeightRatio = 0.6;
PianoKeyboard.blackKeyWidthRatio = 0.58;
class Logger extends Output {
    constructor() {
        super('logger');
    }
    receive(m) {
        console.log('' + m.pitch, m);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vdHlwZXNjcmlwdC9BcHAudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvaW5wdXQudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvbm90ZXMudHMiLCIuLi90eXBlc2NyaXB0L2NvcmUvb3V0cHV0LnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL21lc3NhZ2VzLnRzIiwiLi4vdHlwZXNjcmlwdC9jb3JlL3R5cGVzLnRzIiwiLi4vdHlwZXNjcmlwdC9pbXBsL0Nvbm5lY3Rvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9NaWRpVXRpbHMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvT3NjaWxsYXRvci50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9PdXRwdXRDaG9ydXMudHMiLCIuLi90eXBlc2NyaXB0L2ltcGwvUGlhbm9LZXlib2FyZC50cyIsIi4uL3R5cGVzY3JpcHQvaW1wbC9Mb2dnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFO0lBQzFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUM7UUFFeEIsSUFBSSxTQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUVoQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQztRQUVsQyxJQUFJLEtBQUssR0FBRyxJQUFJLGFBQWEsQ0FDekIsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsRUFDNUIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFDdEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FDekIsQ0FBQztRQUNGLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUIsU0FBUyxDQUFDLFNBQVMsQ0FB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LEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFDL0csSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFdBQVcsQ0FBQyxDQUFRLEVBQUUsS0FBYTtRQUN2QyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDMUMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDOUIsQ0FBQzs7QUF6RXVCLGlDQUFtQixHQUFHLEdBQUcsQ0FBQztBQUMxQixnQ0FBa0IsR0FBRyxJQUFJLENBQUM7QUNKdEQsWUFBYSxTQUFRLE1BQU07SUFFdkI7UUFDSSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVELE9BQU8sQ0FBQyxDQUFVO1FBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNqQyxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZnVuY3Rpb24oKSB7XG4gICAgTWlkaVV0aWxzLmluaXRpYWxpemUoKS50aGVuKCgpID0+IHtcblxuICAgICAgICBsZXQgY29ubmVjdG9yID0gbmV3IENvbm5lY3RvcigpO1xuXG4gICAgICAgIGNvbm5lY3Rvci5hZGRPdXRwdXQobmV3IExvZ2dlcigpKTtcblxuICAgICAgICBsZXQgcGlhbm8gPSBuZXcgUGlhbm9LZXlib2FyZChcbiAgICAgICAgICAgIHsgd2lkdGg6IDEyMzIsIGhlaWdodDogMTIwIH0sXG4gICAgICAgICAgICBQaXRjaC5mcm9tU3RyaW5nKCdBMScpLFxuICAgICAgICAgICAgUGl0Y2guZnJvbVN0cmluZygnQzknKVxuICAgICAgICApO1xuICAgICAgICBjb25uZWN0b3IuYWRkSW5wdXQocGlhbm8pO1xuICAgICAgICBjb25uZWN0b3IuYWRkT3V0cHV0KHBpYW5vKTtcblxuICAgICAgICBpZiAoTWlkaVV0aWxzLmlucHV0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25uZWN0b3IuYWRkSW5wdXQoTWlkaVV0aWxzLmNyZWF0ZUlucHV0KCdtaWRpJywgMCkpO1xuICAgICAgICAgICAgY29ubmVjdG9yLmFkZE91dHB1dChNaWRpVXRpbHMuY3JlYXRlT3V0cHV0KCdtaWRpJywgMCkpO1xuICAgICAgICB9XG4gICAgfSk7XG59KTsiLCJhYnN0cmFjdCBjbGFzcyBJbnB1dCB7XG5cbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuICAgIG9uU2VuZDogKChtOiBNZXNzYWdlKSA9PiBhbnkpIHwgbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5pZCA9IGlkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZW5kKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgaWYgKHRoaXMub25TZW5kICE9IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMub25TZW5kKG0pO1xuICAgICAgICB9XG4gICAgfVxuXG59IiwiYWJzdHJhY3QgY2xhc3MgTm90ZXMge1xuXG4gICAgc3RhdGljIHJlYWRvbmx5IGRlZmF1bHRWZWxvY2l0eSA9IDAuNTtcblxuICAgIHN0YXRpYyBhc051bWJlcihwOiBQaXRjaCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiAocC5vY3RhdmUgLSA0KSAqIDEyICsgcC5jbGFzcztcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9yTnVtYmVyKG46IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQaXRjaChNYXRoLmZsb29yKG4gLyAxMiArIDQpLCAobiAlIDEyICsgMTIpICUgMTIpO1xuICAgIH1cblxuICAgIHN0YXRpYyBmcmVxdWVuY3kocDogUGl0Y2gpIHtcbiAgICAgICAgcmV0dXJuIE1hdGgucG93KDIsIChOb3Rlcy5hc051bWJlcihwKSAtIDQ5KSAvIDEyKSAqIDQ0MDtcbiAgICB9XG5cbn1cbiIsImFic3RyYWN0IGNsYXNzIE91dHB1dCB7XG5cbiAgICByZWFkb25seSBpZDogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoaWQpIHtcbiAgICAgICAgdGhpcy5pZCA9IGlkO1xuICAgIH1cblxuICAgIGFic3RyYWN0IHJlY2VpdmUobTogTWVzc2FnZSk6IHZvaWQ7XG5cbn0iLCJ0eXBlIE1lc3NhZ2UgPVxuICAgIHtcbiAgICAgICAgdHlwZTogJ3N0YXJ0JyxcbiAgICAgICAgcGl0Y2g6IFBpdGNoLFxuICAgICAgICBjaGFubmVsOiBudW1iZXIsXG4gICAgICAgIHZlbG9jaXR5OiBudW1iZXJcbiAgICB9IHwge1xuICAgICAgICB0eXBlOiAnc3RvcCcsXG4gICAgICAgIHBpdGNoOiBQaXRjaFxuICAgIH07IiwiY29uc3QgZW5nbGlzaE5hbWVzID0gWydDJywgJ0MjJywgJ0QnLCAnRCMnLCAnRScsICdGJywgJ0YjJywgJ0cnLCAnRyMnLCAnQScsICdBIycsICdCJ107XG5jb25zdCBsYXRpbk5hbWVzID0gWydEbycsICdEbyMnLCAnUmUnLCAnUmUjJywgJ01pJywgJ0ZhJywgJ0ZhIycsICdTb2wnLCAnU29sIycsICdMYScsICdMYSMnLCAnU2knXTtcbmNvbnN0IGRpYXRvbmljID0gWzAsIDIsIDQsIDUsIDcsIDksIDExXTtcblxuLypcbmVudW0gQWNjaWRlbnRhbCB7XG4gICAgTmF0dXJhbCwgU2hhcnAsIEZsYXRcbn1cblxuZW51bSBEdXJhdGlvblR5cGUge1xuICAgIFJlYWwsIFNoZWV0XG59XG4qL1xuXG5jbGFzcyBQaXRjaCB7XG5cbiAgICByZWFkb25seSBvY3RhdmU6IG51bWJlcjtcbiAgICByZWFkb25seSBjbGFzczogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Iob2N0YXZlOiBudW1iZXIsIGNsc3M6IG51bWJlcikge1xuICAgICAgICB0aGlzLm9jdGF2ZSA9IG9jdGF2ZTtcbiAgICAgICAgdGhpcy5jbGFzcyA9IGNsc3M7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBlbmdsaXNoTmFtZXNbdGhpcy5jbGFzc10gKyB0aGlzLm9jdGF2ZTtcbiAgICB9XG5cbiAgICBpc0RpYXRvbmljKCkge1xuICAgICAgICByZXR1cm4gZGlhdG9uaWMuaW5kZXhPZih0aGlzLmNsYXNzKSA+IC0xXG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21TdHJpbmcoczogc3RyaW5nKSB7XG4gICAgICAgIHZhciBvY3RhdmUgPSBwYXJzZUludChzLnN1YnN0cmluZyhzLmxlbmd0aCAtIDEpKTtcbiAgICAgICAgdmFyIGNsc3MgPSBlbmdsaXNoTmFtZXMuaW5kZXhPZihzLnN1YnN0cmluZygwLCBzLmxlbmd0aCAtIDEpKTtcbiAgICAgICAgcmV0dXJuIG5ldyBQaXRjaChvY3RhdmUsIGNsc3MpO1xuICAgIH1cbn1cblxuLypcbmNsYXNzIE5vdGUge1xuICAgIHBpdGNoOiBQaXRjaDtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xuICAgIGR1cmF0aW9uOiBudW1iZXIgfCBudWxsO1xufVxuKi9cblxudHlwZSBEaW1lbnNpb25zID0geyB3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciB9O1xuXG5cblxuXG4iLCJjbGFzcyBDb25uZWN0b3Ige1xuXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGlucHV0czogSW5wdXRbXSA9IFtdO1xuICAgIHByb3RlY3RlZCByZWFkb25seSBvdXRwdXRzOiBPdXRwdXRbXSA9IFtdO1xuXG4gICAgYWRkSW5wdXQoaTogSW5wdXQpIHtcbiAgICAgICAgdGhpcy5pbnB1dHMucHVzaChpKTtcbiAgICAgICAgaS5vblNlbmQgPSAobTogTWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXRzLmZvckVhY2gobyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKG8uaWQgIT0gaS5pZCkge1xuICAgICAgICAgICAgICAgICAgICBvLnJlY2VpdmUobSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRPdXRwdXQobzogT3V0cHV0KSB7XG4gICAgICAgIHRoaXMub3V0cHV0cy5wdXNoKG8pO1xuICAgIH1cblxufSIsImNsYXNzIEtleWJvYXJkIGV4dGVuZHMgSW5wdXQge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlzOiAnenN4ZGN2Z2JobmptcTJ3M2VyNXQ2eTd1aTlvMHAnO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdmVsb2NpdHk6IG51bWJlciA9IE5vdGVzLmRlZmF1bHRWZWxvY2l0eTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNoYW5uZWw6IG51bWJlciA9IDE7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoJ2tleWJvYXJkJyk7XG5cbiAgICAgICAgd2luZG93Lm9ua2V5ZG93biA9IGV2dCA9PiB0aGlzLnNlbmQoe1xuICAgICAgICAgICAgdHlwZTogJ3N0YXJ0JyxcbiAgICAgICAgICAgIHBpdGNoOiB0aGlzLmZvcktleShldnQud2hpY2gpLFxuICAgICAgICAgICAgdmVsb2NpdHk6IHRoaXMudmVsb2NpdHksXG4gICAgICAgICAgICBjaGFubmVsOiB0aGlzLmNoYW5uZWxcbiAgICAgICAgfSk7XG4gICAgICAgIHdpbmRvdy5vbmtleXVwID0gZXZ0ID0+IHRoaXMuc2VuZCh7XG4gICAgICAgICAgICB0eXBlOiAnc3RvcCcsXG4gICAgICAgICAgICBwaXRjaDogdGhpcy5mb3JLZXkoZXZ0LndoaWNoKVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcktleShuOiBudW1iZXIpOiBQaXRjaCB7XG4gICAgICAgIHJldHVybiBOb3Rlcy5mb3JOdW1iZXIobik7XG4gICAgfVxuXG59ICIsIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9leHQvd2VibWlkaS5kLnRzXCIgLz5cblxuY2xhc3MgTWlkaU1lc3NhZ2Uge1xuICAgIGNvbW1hbmQ6IG51bWJlcjtcbiAgICBjaGFubmVsOiBudW1iZXI7XG4gICAgdHlwZTogbnVtYmVyO1xuICAgIG5vdGU6IG51bWJlcjtcbiAgICB2ZWxvY2l0eTogbnVtYmVyO1xufVxuXG5jbGFzcyBNaWRpVXRpbHMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZW5hYmxlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgc3RhdGljIGluZm86IFdlYk1pZGkuTUlESUFjY2VzcztcbiAgICBzdGF0aWMgb3V0cHV0czogQXJyYXk8V2ViTWlkaS5NSURJT3V0cHV0PjtcbiAgICBzdGF0aWMgaW5wdXRzOiBBcnJheTxXZWJNaWRpLk1JRElJbnB1dD47XG5cbiAgICBzdGF0aWMgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbmF2aWdhdG9yLnJlcXVlc3RNSURJQWNjZXNzKCkudGhlbihcbiAgICAgICAgICAgICAgICAgICAgeCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5mbyA9IHg7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMuaW5wdXRzID0gQXJyYXkuZnJvbSh4LmlucHV0cy52YWx1ZXMoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBNaWRpVXRpbHMub3V0cHV0cyA9IEFycmF5LmZyb20oeC5vdXRwdXRzLnZhbHVlcygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIE1pZGlVdGlscy5lbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgTWlkaVV0aWxzLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBzdGF0aWMgZGVjb2RlKGRhdGE6IFVpbnQ4QXJyYXkpOiBNaWRpTWVzc2FnZSB7XG4gICAgICAgIHZhciBtID0gbmV3IE1pZGlNZXNzYWdlKCk7XG4gICAgICAgIG0uY29tbWFuZCA9IGRhdGFbMF0gPj4gNDtcbiAgICAgICAgbS5jaGFubmVsID0gZGF0YVswXSAmIDB4ZjtcbiAgICAgICAgbS50eXBlID0gZGF0YVswXSAmIDB4ZjA7XG4gICAgICAgIG0ubm90ZSA9IGRhdGFbMV07XG4gICAgICAgIG0udmVsb2NpdHkgPSBkYXRhWzJdO1xuICAgICAgICByZXR1cm4gbTtcbiAgICB9O1xuXG4gICAgc3RhdGljIGVuY29kZShtOiBNaWRpTWVzc2FnZSkge1xuICAgICAgICB2YXIgeCA9IChtLmNoYW5uZWwgJiAweGYpIHwgKG0udHlwZSAmIDB4ZjApIHwgKG0uY29tbWFuZCA8PCA0KTtcbiAgICAgICAgcmV0dXJuIFt4LCBtLm5vdGUsIG0udmVsb2NpdHldO1xuICAgIH07XG5cbiAgICBzdGF0aWMgY3JlYXRlSW5wdXQoaWQ6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gICAgICAgIHJldHVybiBuZXcgTWlkaUlucHV0KGlkLCB0aGlzLmlucHV0c1tuXSk7XG4gICAgfVxuXG4gICAgc3RhdGljIGNyZWF0ZU91dHB1dChpZDogc3RyaW5nLCBuOiBudW1iZXIpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBNaWRpT3V0cHV0KGlkLCB0aGlzLm91dHB1dHNbbl0pO1xuICAgIH1cblxuICAgIHN0YXRpYyB0b1BpdGNoKGNvZGU6IG51bWJlcik6IFBpdGNoIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQaXRjaChNYXRoLnRydW5jKGNvZGUgLyAxMiksIGNvZGUgJSAxMik7XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21QaXRjaChwaXRjaDogUGl0Y2gpIHtcbiAgICAgICAgcmV0dXJuIHBpdGNoLm9jdGF2ZSAqIDEyICsgcGl0Y2guY2xhc3M7XG4gICAgfVxuXG59XG5cblxuXG5jbGFzcyBNaWRpSW5wdXQgZXh0ZW5kcyBJbnB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dDtcblxuICAgIGNvbnN0cnVjdG9yKGlkOiBzdHJpbmcsIGlucHV0OiBXZWJNaWRpLk1JRElJbnB1dCkge1xuICAgICAgICBzdXBlcihpZCk7XG4gICAgICAgIHRoaXMuaW5wdXQgPSBpbnB1dDtcblxuICAgICAgICB0aGlzLmlucHV0Lm9ubWlkaW1lc3NhZ2UgPSBldnQgPT4ge1xuICAgICAgICAgICAgdmFyIG0gPSBNaWRpVXRpbHMuZGVjb2RlKGV2dC5kYXRhKTtcbiAgICAgICAgICAgIHZhciBwaXRjaCA9IE1pZGlVdGlscy50b1BpdGNoKG0ubm90ZSk7XG4gICAgICAgICAgICBpZiAobS50eXBlID09IDEyOCB8fCAobS50eXBlID09IDE0NCAmJiBtLnZlbG9jaXR5ID09IDApKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZW5kKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3N0b3AnLFxuICAgICAgICAgICAgICAgICAgICBwaXRjaDogcGl0Y2hcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobS50eXBlID09IDE0NCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFydCcsXG4gICAgICAgICAgICAgICAgICAgIHBpdGNoOiBwaXRjaCxcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHk6IE1hdGgudHJ1bmMobS52ZWxvY2l0eSAvIDEyNyksXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgTWlkaU91dHB1dCBleHRlbmRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IG91dHB1dDogV2ViTWlkaS5NSURJT3V0cHV0O1xuXG4gICAgY29uc3RydWN0b3IoaWQ6IHN0cmluZywgb3V0cHV0OiBXZWJNaWRpLk1JRElPdXRwdXQpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICB9XG5cbiAgICByZWNlaXZlKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChtLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0JzogcmV0dXJuIHRoaXMub3V0cHV0LnNlbmQoTWlkaVV0aWxzLmVuY29kZSh7IC8vXG4gICAgICAgICAgICAgICAgY29tbWFuZDogOSwgLy9cbiAgICAgICAgICAgICAgICBjaGFubmVsOiAwLCAvL1xuICAgICAgICAgICAgICAgIHR5cGU6IDE0NCwgLy9cbiAgICAgICAgICAgICAgICBub3RlOiBNaWRpVXRpbHMuZnJvbVBpdGNoKG0ucGl0Y2gpLCAvLyBcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eTogTWF0aC50cnVuYyhtLnZlbG9jaXR5ICogMTI3KSAvLyBcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIGNhc2UgJ3N0b3AnOiByZXR1cm4gdGhpcy5vdXRwdXQuc2VuZChNaWRpVXRpbHMuZW5jb2RlKHsgLy9cbiAgICAgICAgICAgICAgICBjb21tYW5kOiA5LFxuICAgICAgICAgICAgICAgIGNoYW5uZWw6IDAsXG4gICAgICAgICAgICAgICAgdHlwZTogMTQ0LFxuICAgICAgICAgICAgICAgIG5vdGU6IE1pZGlVdGlscy5mcm9tUGl0Y2gobS5waXRjaCksXG4gICAgICAgICAgICAgICAgdmVsb2NpdHk6IDBcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxufSIsInR5cGUgV2F2ZVR5cGUgPSAnc2luZScgfCAnc3F1YXJlJyB8ICdzYXd0b290aCcgfCAndHJpYW5nbGUnO1xuXG5jbGFzcyBPc2NpbGxhdG9yIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3NjOiBPc2NpbGxhdG9yTm9kZTtcblxuICAgIGNvbnN0cnVjdG9yKHR5cGU6IFdhdmVUeXBlKSB7XG4gICAgICAgIHN1cGVyKCdvc2NpbGxhdG9yJyk7XG4gICAgICAgIHZhciBjdHggPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gICAgICAgIHRoaXMub3NjID0gY3R4LmNyZWF0ZU9zY2lsbGF0b3IoKTtcbiAgICAgICAgdGhpcy5vc2MudHlwZSA9IHR5cGU7XG4gICAgICAgIHRoaXMub3NjLmNvbm5lY3QoY3R4LmRlc3RpbmF0aW9uKTtcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gsIHZlbG9jaXR5OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KHBpdGNoKTtcbiAgICAgICAgdGhpcy5vc2Muc3RhcnQoKTtcbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLm9zYy5zdG9wKCk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIHN3aXRjaCAobS50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdGFydCc6XG4gICAgICAgICAgICAgICAgdGhpcy5vc2MuZnJlcXVlbmN5LnZhbHVlID0gTm90ZXMuZnJlcXVlbmN5KG0ucGl0Y2gpO1xuICAgICAgICAgICAgICAgIHRoaXMub3NjLnN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdzdG9wJzogdGhpcy5vc2Muc3RvcCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG59IiwiY2xhc3MgT3V0cHV0Q2hvcnVzIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0OiBhbnk7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZWxheTogbnVtYmVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVjYXk6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRpbWVzOiBudW1iZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihpZCwgb3V0cHV0OiBPdXRwdXQsIGRlbGF5OiBudW1iZXIsIGRlY2F5OiBudW1iZXIsIHRpbWVzOiBudW1iZXIpIHtcbiAgICAgICAgc3VwZXIoaWQpO1xuICAgICAgICB0aGlzLm91dHB1dCA9IG91dHB1dDtcbiAgICAgICAgdGhpcy5kZWxheSA9IGRlbGF5O1xuICAgICAgICB0aGlzLmRlY2F5ID0gZGVjYXk7XG4gICAgICAgIHRoaXMudGltZXMgPSB0aW1lcztcbiAgICB9XG5cbiAgICBzdGFydChwaXRjaDogUGl0Y2gsIHZlbG9jaXR5KSB7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy50aW1lczsgaSsrKSB7XG4gICAgICAgICAgICB2ZWxvY2l0eSAqPSB0aGlzLmRlY2F5O1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm91dHB1dC5zdGFydChwaXRjaCwgdmVsb2NpdHksIHRoaXMuZGVsYXkgKiAoaSArIDEpKSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIHN0b3AocGl0Y2g6IFBpdGNoKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RvcChwaXRjaCksIHRoaXMuZGVsYXkgKiAodGhpcy50aW1lcyArIDEpKTtcbiAgICB9XG5cbiAgICByZWNlaXZlKG06IE1lc3NhZ2UpIHtcbiAgICAgICAgc3dpdGNoIChtLnR5cGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0YXJ0JzpcbiAgICAgICAgICAgICAgICBsZXQgdmVsb2NpdHkgPSBtLnZlbG9jaXR5O1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy50aW1lczsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5ICo9IHRoaXMuZGVjYXk7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5vdXRwdXQuc3RhcnQobS5waXRjaCwgdmVsb2NpdHksIHRoaXMuZGVsYXkgKiAoaSArIDEpKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnc3RvcCc6XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLm91dHB1dC5zdG9wKG0ucGl0Y2gpLCB0aGlzLmRlbGF5ICogKHRoaXMudGltZXMgKyAxKSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbn0iLCJcbmNsYXNzIFBpYW5vS2V5Ym9hcmQgZXh0ZW5kcyBJbnB1dCBpbXBsZW1lbnRzIE91dHB1dCB7XG5cbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBibGFja0tleUhlaWdodFJhdGlvID0gMC42O1xuICAgIHByaXZhdGUgc3RhdGljIHJlYWRvbmx5IGJsYWNrS2V5V2lkdGhSYXRpbyA9IDAuNTg7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGRpbTogRGltZW5zaW9ucztcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhbnZhczogU25hcC5QYXBlcjtcblxuXG4gICAgcHJpdmF0ZSByZWFkb25seSBrZXlMZW5ndGg6IG51bWJlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZpcnN0S2V5OiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSB3aGl0ZUtleVdpZHRoOiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBibGFja0tleVdpZHRoOiBudW1iZXI7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGtleXNQYWludGVkOiBBcnJheTxTbmFwLkVsZW1lbnQ+ID0gW107XG5cbiAgICBjb25zdHJ1Y3RvcihkaW06IERpbWVuc2lvbnMsIGZpcnN0OiBQaXRjaCwgbGFzdDogUGl0Y2gpIHtcbiAgICAgICAgc3VwZXIoJ3BpYW5vS2V5Ym9hcmQnKTtcblxuICAgICAgICB0aGlzLmRpbSA9IGRpbTtcbiAgICAgICAgdGhpcy5jYW52YXMgPSBTbmFwKGRpbS53aWR0aCwgZGltLmhlaWdodCk7XG5cblxuICAgICAgICB0aGlzLmZpcnN0S2V5ID0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpO1xuICAgICAgICB0aGlzLmtleUxlbmd0aCA9IE5vdGVzLmFzTnVtYmVyKGxhc3QpIC0gTm90ZXMuYXNOdW1iZXIoZmlyc3QpICsgMTtcblxuICAgICAgICB0aGlzLndoaXRlS2V5V2lkdGggPSBNYXRoLnRydW5jKGRpbS53aWR0aCAvIHRoaXMua2V5TGVuZ3RoKTtcbiAgICAgICAgdGhpcy5ibGFja0tleVdpZHRoID0gdGhpcy53aGl0ZUtleVdpZHRoICogUGlhbm9LZXlib2FyZC5ibGFja0tleVdpZHRoUmF0aW87XG5cbiAgICAgICAgdGhpcy5kcmF3S2V5cygpO1xuICAgIH1cblxuICAgIHJlY2VpdmUobTogTWVzc2FnZSkge1xuICAgICAgICBzd2l0Y2ggKG0udHlwZSkge1xuICAgICAgICAgICAgY2FzZSAnc3RhcnQnOiByZXR1cm4gdGhpcy5kcmF3UHJlc3NlZChtLnBpdGNoLCAncmVkJyk7XG4gICAgICAgICAgICBjYXNlICdzdG9wJzogcmV0dXJuIHRoaXMuZHJhd1ByZXNzZWQobS5waXRjaCwgJ3doaXRlJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdG9wKHBpdGNoOiBQaXRjaCkge1xuICAgICAgICB0aGlzLmRyYXdQcmVzc2VkKHBpdGNoLCAnd2hpdGUnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRyYXdLZXlzKCkge1xuICAgICAgICBsZXQgYXR0cnMgPSB7IGZpbGw6ICcjZmZmJywgc3Ryb2tlOiAnIzAwMCcsIHN0cm9rZVdpZHRoOiAxIH07XG4gICAgICAgIGZvciAobGV0IGtleSA9IDA7IGtleSA8IHRoaXMua2V5TGVuZ3RoOyBrZXkrKykge1xuICAgICAgICAgICAgbGV0IHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoO1xuICAgICAgICAgICAgbGV0IHJlY3QgPSB0aGlzLmNhbnZhcy5yZWN0KHN0YXJ0LCAwLCB0aGlzLndoaXRlS2V5V2lkdGgsIHRoaXMuZGltLmhlaWdodCk7XG4gICAgICAgICAgICByZWN0LmF0dHIoYXR0cnMpO1xuICAgICAgICAgICAgdGhpcy5rZXlzUGFpbnRlZC5wdXNoKHJlY3QpO1xuICAgICAgICAgICAgcmVjdC5kYXRhKCdrZXknLCBrZXkpO1xuXG4gICAgICAgICAgICByZWN0LmNsaWNrKChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFydCcsXG4gICAgICAgICAgICAgICAgICAgIHBpdGNoOiBOb3Rlcy5mb3JOdW1iZXIoa2V5ICsgdGhpcy5maXJzdEtleSksXG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5OiBOb3Rlcy5kZWZhdWx0VmVsb2NpdHksXG4gICAgICAgICAgICAgICAgICAgIGNoYW5uZWw6IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgYXR0cnMgPSB7IGZpbGw6ICcjMDAwJywgc3Ryb2tlOiAnIzAwMCcsIHN0cm9rZVdpZHRoOiAxIH07XG4gICAgICAgIGZvciAobGV0IGtleSA9IDE7IGtleSA8IHRoaXMua2V5TGVuZ3RoOyBrZXkrKykge1xuICAgICAgICAgICAgbGV0IHN0YXJ0ID0ga2V5ICogdGhpcy53aGl0ZUtleVdpZHRoIC0gMC41ICogdGhpcy5ibGFja0tleVdpZHRoO1xuICAgICAgICAgICAgbGV0IHJlY3QgPSB0aGlzLmNhbnZhcy5yZWN0KHN0YXJ0LCAwLCB0aGlzLmJsYWNrS2V5V2lkdGgsIHRoaXMuZGltLmhlaWdodCAqIFBpYW5vS2V5Ym9hcmQuYmxhY2tLZXlIZWlnaHRSYXRpbyk7XG4gICAgICAgICAgICByZWN0LmF0dHIoYXR0cnMpO1xuICAgICAgICAgICAgdGhpcy5rZXlzUGFpbnRlZC5wdXNoKHJlY3QpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkcmF3UHJlc3NlZChwOiBQaXRjaCwgY29sb3I6IHN0cmluZykge1xuICAgICAgICBsZXQgbiA9IE5vdGVzLmFzTnVtYmVyKHApIC0gdGhpcy5maXJzdEtleTtcbiAgICAgICAgbGV0IGtleSA9IHRoaXMua2V5c1BhaW50ZWRbbl07XG4gICAgICAgIGtleS5hdHRyKHsgZmlsbDogY29sb3IgfSk7XG4gICAgfVxuXG59IiwiY2xhc3MgTG9nZ2VyIGV4dGVuZHMgT3V0cHV0IHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcignbG9nZ2VyJyk7XG4gICAgfVxuXG4gICAgcmVjZWl2ZShtOiBNZXNzYWdlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCcnICsgbS5waXRjaCwgbSk7XG4gICAgfVxuXG59Il19